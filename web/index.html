<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Echoes in the Atrium</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Special+Elite&family=Source+Serif+4:wght@400;600&display=swap" rel="stylesheet">
  <style>
    /* ── Reset & Variables ─────────────────────────────────── */
    :root {
      /* ── Noir theme palette (source of truth) ── */
      --noir-warm: #1a1510;
      --noir-panel: #1c1712;
      --noir-panel-alt: #231e17;
      --noir-input: #2a2319;
      --noir-text: #e8dcc8;
      --noir-text-dim: #b8a88e;
      --noir-text-faint: #7a6b55;
      --noir-amber: #d4a050;
      --noir-amber-glow: rgba(212,160,80,0.15);
      --noir-amber-border: rgba(212,160,80,0.35);
      --noir-smoke: rgba(26,21,16,0.85);
      --font-noir: "Playfair Display", "Georgia", serif;
      --font-typewriter: "Special Elite", "Courier New", monospace;
      --font-body-serif: "Source Serif 4", "Georgia", serif;
      /* ── Legacy aliases → noir remap ──────── */
      --bg-dark: var(--noir-warm);
      --bg-panel: var(--noir-panel);
      --bg-panel-alt: var(--noir-panel-alt);
      --bg-input: var(--noir-input);
      --border: rgba(212,160,80,0.15);
      --border-active: var(--noir-amber);
      --text: var(--noir-text);
      --text-dim: var(--noir-text-dim);
      --text-faint: var(--noir-text-faint);
      --accent: var(--noir-amber);
      --accent-glow: var(--noir-amber-glow);
      --danger: #f87171;
      --success: #a8b88e;
      --gold: var(--noir-amber);
      --font: var(--font-body-serif);
      --font-mono: "SF Mono", "Fira Code", "Cascadia Code", monospace;
      /* Manila folder palette */
      --manila-bg: #f5e6c8;
      --manila-tab: #e8d5a8;
      --manila-tab-active: #f5e6c8;
      --manila-tab-text: #2a2318;
      --manila-tab-inactive-text: #6b5b3e;
      --manila-border: #c4a96a;
      --manila-fold-highlight: #faf0db;
      --screen-transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      --noir-shadow: rgba(0,0,0,0.4);
      --gold-dim: rgba(212,160,80,0.12);
      --gold-border: rgba(212,160,80,0.3);
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; }
    body {
      font-family: var(--font);
      background: var(--bg-dark);
      color: var(--text);
      overflow: hidden;
    }

    /* ── Title Card ────────────────────────────────────────── */
    #title-card {
      position: fixed; inset: 0; z-index: 150;
      display: flex; align-items: center; justify-content: center;
      background: linear-gradient(160deg, rgba(26,21,16,0.97), rgba(28,23,18,0.95)),
        url("data:image/svg+xml,%3Csvg width='60' height='60' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M30 0v60M0 30h60' stroke='%23d4a05008' fill='none'/%3E%3C/svg%3E");
      transition: opacity 0.5s ease, transform 0.5s ease;
    }
    #title-card.hidden { display: none; }
    #title-card.dismissed { opacity: 0; transform: scale(0.96); pointer-events: none; }
    .title-card-inner {
      position: relative;
      max-width: 520px; width: 90vw;
      background: var(--manila-bg);
      border: 2px solid var(--manila-border);
      border-radius: 4px;
      padding: 3.5rem 3rem 2.5rem;
      box-shadow: 0 32px 64px rgba(0,0,0,0.5), inset 0 1px 0 var(--manila-fold-highlight);
      text-align: center;
      transform: rotate(-0.5deg);
      /* Aged paper texture via gradient overlay */
      background-image:
        radial-gradient(ellipse at 20% 50%, rgba(196,169,106,0.15) 0%, transparent 70%),
        radial-gradient(ellipse at 80% 20%, rgba(139,115,63,0.1) 0%, transparent 60%),
        linear-gradient(180deg, var(--manila-fold-highlight) 0%, var(--manila-bg) 8%, var(--manila-tab) 100%);
    }
    .title-card-classified {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%) rotate(-12deg);
      font-family: var(--font-typewriter);
      font-size: 4.5rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      color: rgba(200, 50, 50, 0.08);
      pointer-events: none;
      white-space: nowrap;
    }
    .title-card-stamp {
      font-family: var(--font-typewriter);
      font-size: 2.2rem;
      font-weight: 400;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: #2a1f12;
      margin-bottom: 0.5rem;
      position: relative;
      z-index: 1;
      text-shadow: 1px 1px 0 rgba(0,0,0,0.05);
    }
    .title-card-subtitle {
      font-family: var(--font-body-serif);
      font-size: 1rem;
      font-style: italic;
      color: #6b5b3e;
      margin-bottom: 1.5rem;
      position: relative; z-index: 1;
    }
    .title-card-meta {
      display: flex;
      justify-content: center;
      gap: 0.6rem;
      font-family: var(--font-typewriter);
      font-size: 0.72rem;
      color: #8b7340;
      margin-bottom: 2rem;
      position: relative; z-index: 1;
    }
    .title-card-open-btn {
      font-family: var(--font-typewriter);
      background: #2a1f12;
      color: var(--manila-bg);
      border: none;
      border-radius: 4px;
      padding: 0.75rem 2rem;
      font-size: 0.85rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      cursor: pointer;
      transition: transform 0.15s, box-shadow 0.15s, background 0.15s;
      position: relative; z-index: 1;
    }
    .title-card-open-btn:hover {
      background: #3d2e1a;
      transform: translateY(-1px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.3);
    }
    /* ── Auth Prompt Screen (between title card and game) ── */
    #auth-prompt {
      position: fixed; inset: 0; z-index: 145;
      display: flex; align-items: center; justify-content: center;
      background: linear-gradient(160deg, #0e0c09, #14110c);
      animation: fadeIn 0.3s ease;
    }
    #auth-prompt.hidden { display: none; }
    .auth-prompt-card {
      text-align: center;
      max-width: 380px; width: 90%;
      padding: 2.5rem 2rem;
    }
    .auth-prompt-heading {
      font-family: var(--font-noir);
      color: var(--accent);
      font-size: 1.4rem;
      margin-bottom: 0.6rem;
    }
    .auth-prompt-desc {
      font-family: var(--font-typewriter);
      color: var(--text-dim);
      font-size: 0.82rem;
      line-height: 1.6;
      margin-bottom: 1.8rem;
    }
    .auth-prompt-buttons {
      display: flex; gap: 0.7rem; justify-content: center;
      margin-bottom: 1.2rem;
    }
    .auth-prompt-btn {
      font-family: var(--font-typewriter);
      border: none;
      border-radius: 6px;
      padding: 0.7rem 1.6rem;
      font-size: 0.82rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      cursor: pointer;
      transition: transform 0.15s, box-shadow 0.15s, background 0.15s;
    }
    .auth-prompt-btn.primary {
      background: var(--accent);
      color: var(--bg-dark);
    }
    .auth-prompt-btn.primary:hover {
      background: #b8862e;
      transform: translateY(-1px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.4);
    }
    .auth-prompt-skip {
      font-family: var(--font-typewriter);
      background: none;
      border: none;
      color: var(--text-dim);
      font-size: 0.78rem;
      cursor: pointer;
      text-decoration: underline;
      text-underline-offset: 3px;
      transition: color 0.15s;
      margin-bottom: 0.5rem;
    }
    .auth-prompt-skip:hover {
      color: var(--text-main);
    }
    .auth-prompt-warning {
      font-family: var(--font-typewriter);
      color: rgba(212,160,80,0.35);
      font-size: 0.68rem;
      font-style: italic;
    }

    /* ── Hub Screen ────────────────────────────────────────── */
    #hub-screen {
      display: none;
      height: 100vh;
      flex-direction: column;
      background: var(--bg-dark);
      overflow: hidden;
    }
    #hub-screen.active { display: flex; }

    /* ── Manila Folder Tabs ────────────────────────────────── */
    .manila-tabs {
      display: flex;
      gap: 0;
      padding: 0 2rem;
      padding-top: 0.75rem;
      background: var(--bg-dark);
      flex-shrink: 0;
    }
    .manila-tab {
      position: relative;
      padding: 0.7rem 2rem 0.6rem;
      border: none;
      cursor: pointer;
      font-size: 0.8rem; font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      border-radius: 8px 8px 0 0;
      clip-path: polygon(8% 0%, 92% 0%, 100% 100%, 0% 100%);
      background: var(--bg-panel-alt);
      color: var(--text-faint);
      transition: background 0.2s, color 0.2s;
      min-width: 180px;
      text-align: center;
    }
    .manila-tab.active {
      background: var(--manila-tab-active);
      color: var(--manila-tab-text);
      z-index: 2;
    }
    .manila-tab:not(.active):hover {
      background: var(--bg-input);
      color: var(--text-dim);
    }
    .manila-tab .manila-tab-label { pointer-events: none; }
    .manila-tab .tab-flash {
      color: var(--gold);
    }
    .manila-tabs-spacer { flex: 1; }
    .manila-tab-icon {
      min-width: auto;
      width: auto;
      padding: 0.7rem 1rem;
      display: flex; align-items: center; justify-content: center;
      clip-path: none;
      border-radius: 8px 8px 0 0;
    }
    .manila-tab-icon svg {
      width: 16px; height: 16px;
      stroke: currentColor; fill: none;
      stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;
      pointer-events: none;
    }

    .hub-content {
      flex: 1;
      overflow-y: auto;
      border-top: 3px solid var(--manila-border);
      background: var(--bg-dark);
    }
    .hub-panel { display: none; }
    .hub-panel.active { display: block; }

    /* ── NPC Grid (5 + 4 staggered rows) ───────────────────── */
    .npc-grid-container {
      padding: 1.25rem 2rem 0;
      max-width: 1200px;
      margin: 0 auto;
    }
    .npc-row {
      display: flex;
      justify-content: center;
      gap: 1.25rem;
      margin-bottom: 1rem;
    }
    .npc-card {
      background: var(--bg-panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
      position: relative;
      width: 180px;
      flex-shrink: 0;
    }
    .npc-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 32px rgba(0,0,0,0.4);
      border-color: var(--accent);
    }
    .npc-card.has-talked { border-color: rgba(168,184,142,0.5); }
    .npc-card.has-talked::after {
      content: "";
      position: absolute; top: 10px; right: 10px;
      width: 10px; height: 10px;
      border-radius: 50%;
      background: var(--success);
      box-shadow: 0 0 6px rgba(168,184,142,0.4);
    }
    .npc-card-portrait {
      width: 100%;
      aspect-ratio: 2 / 3;
      overflow: hidden;
      background: var(--bg-input);
    }
    .npc-card-portrait img {
      width: 100%; height: 100%;
      object-fit: cover;
      transition: transform 0.3s;
    }
    .npc-card:hover .npc-card-portrait img {
      transform: scale(1.05);
    }
    .npc-card-info {
      padding: 0.6rem 0.75rem;
      text-align: center;
    }
    .npc-card-name {
      font-family: var(--font-noir);
      font-size: 0.88rem; font-weight: 700;
      margin-bottom: 0.15rem;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .npc-card-role {
      font-size: 0.72rem;
      color: var(--text-faint);
      font-style: italic;
    }
    /* Partner (Lila) card distinction */
    .npc-card-partner {
      border-color: rgba(212,160,80,0.4);
      box-shadow: 0 0 12px rgba(212,160,80,0.08);
    }
    .npc-card-partner:hover {
      border-color: var(--accent);
    }
    .npc-card-partner::before {
      content: "★";
      position: absolute;
      top: 8px; left: 8px;
      width: 22px; height: 22px;
      border-radius: 50%;
      background: rgba(212,160,80,0.9);
      color: #1a1510;
      font-size: 0.65rem;
      display: flex; align-items: center; justify-content: center;
      z-index: 2;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }

    .accuse-section {
      display: flex;
      justify-content: center;
      padding: 1.5rem 0 1rem;
    }
    #hub-accuse-btn {
      font-family: var(--font-typewriter);
      padding: 0.75rem 2rem;
      border: 1.5px solid rgba(248,113,113,0.4);
      border-radius: 6px;
      background: rgba(248,113,113,0.1);
      color: var(--danger);
      font-size: 0.85rem; font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.08em;
      cursor: pointer;
      transition: background 0.15s, border-color 0.15s;
    }
    #hub-accuse-btn:hover {
      background: rgba(248,113,113,0.2);
      border-color: var(--danger);
    }

    /* ── Case Board (Evidence + Timeline) ──────────────────── */
    .caseboard-layout {
      padding: 2rem;
      max-width: 900px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 2rem;
    }
    .caseboard-section {
      background: var(--bg-panel);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 1.25rem;
    }
    .caseboard-heading {
      font-family: var(--font-noir);
      font-size: 0.78rem; font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--gold);
      margin-bottom: 0.75rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border);
    }

    /* ── Case Board Briefing ─────────────────────────────── */
    .caseboard-briefing-section { padding: 0; }
    .caseboard-briefing-toggle {
      all: unset;
      display: block;
      width: 100%;
      cursor: pointer;
      padding: 1.25rem;
      box-sizing: border-box;
    }
    .caseboard-briefing-toggle h3 {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .cb-briefing-chevron {
      transition: transform 0.25s ease;
      color: var(--gold);
    }
    .caseboard-briefing-toggle[aria-expanded="true"] .cb-briefing-chevron {
      transform: rotate(180deg);
    }
    .caseboard-briefing-body {
      display: none;
      padding: 0 1.25rem 1.25rem;
      font-size: 0.88rem;
      line-height: 1.7;
      color: var(--text-dim);
      border-top: 1px solid var(--border);
      margin: 0 1.25rem;
      padding-top: 1rem;
    }
    .caseboard-briefing-body.open {
      display: block;
    }
    .caseboard-briefing-body strong { color: var(--text); }
    .caseboard-briefing-body p { margin-bottom: 0.75rem; }
    .caseboard-briefing-body p:last-child { margin-bottom: 0; }

    /* ── Chat Screen ───────────────────────────────────────── */
    #chat-screen {
      display: none;
      height: 100vh;
      flex-direction: column;
      background: var(--bg-dark);
      overflow: hidden;
    }
    #chat-screen.active { display: flex; }

    .chat-manila-tabs {
      flex-shrink: 0;
    }

    /* Chat layout: portrait | chat+dossier */
    .chat-layout {
      flex: 1;
      display: grid;
      grid-template-columns: 380px 1fr;
      min-height: 0;
      overflow: hidden;
      border-top: 3px solid var(--manila-border);
    }

    /* Portrait panel */
    .chat-portrait-panel {
      display: flex;
      flex-direction: column;
      background: var(--bg-panel);
      border-right: 1px solid var(--border);
      overflow: hidden;
    }
    .portrait-frame {
      position: relative;
      flex: 1 1 0%;
      min-height: 150px;
      overflow: hidden;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      background: var(--bg-input);
    }
    .portrait-frame img {
      width: 100%; height: 100%;
      object-fit: cover;
      object-position: top center;
      transition: opacity 0.3s ease;
    }
    .portrait-nameplate {
      padding: 1.25rem 0.75rem 0.75rem;
      text-align: center;
      background: var(--bg-panel);
      border-top: 1px solid var(--border);
      flex-shrink: 0;
    }
    .portrait-nameplate-row {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    .portrait-nameplate-info {
      flex: 1;
      min-width: 0;
      text-align: left;
    }
    .portrait-name {
      font-family: var(--font-noir);
      font-size: 1.1rem; font-weight: 700;
      margin-bottom: 0.15rem;
    }
    .portrait-role {
      font-size: 0.75rem;
      color: var(--text-faint);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 0.25rem;
      font-style: italic;
    }
    .portrait-status {
      font-size: 0.72rem;
      color: var(--text-dim);
      font-style: italic;
    }
    .portrait-status:empty { display: none; }

    /* ── Portrait Info Button + Bio Tooltip ─────────────── */
    .portrait-info-btn {
      position: absolute;
      top: 0.5rem; right: 0.5rem;
      width: 28px; height: 28px;
      border-radius: 50%;
      border: 1px solid rgba(212,160,80,0.25);
      background: rgba(26,21,16,0.6);
      color: var(--text-dim);
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      z-index: 2;
      transition: background 0.2s, color 0.2s;
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
    }
    .portrait-info-btn:hover {
      background: rgba(26,21,16,0.8);
      color: var(--text);
    }
    .portrait-bio-tooltip {
      display: none;
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(26,21,16,0.92);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      color: var(--text-dim);
      font-size: 0.95rem;
      line-height: 1.6;
      padding: 2.5rem 1rem 1rem;
      overflow-y: auto;
      z-index: 1;
      animation: fadeIn 0.2s ease;
    }
    .portrait-bio-tooltip.visible { display: block; }

    /* ── Chat Discovery Card ───────────────────────────── */
    .chat-discovery-card {
      margin: 0.5rem 1rem;
      padding: 0.7rem 0.9rem 0.7rem 1rem;
      background: linear-gradient(135deg, rgba(212,160,80,0.08), rgba(212,160,80,0.03));
      border: 1px solid rgba(212,160,80,0.18);
      border-left: 3px solid var(--noir-amber);
      border-radius: 2px 8px 8px 2px;
      animation: discoveryReveal 0.5s ease;
      position: relative;
      box-shadow: inset 0 0 20px rgba(212,160,80,0.04);
    }
    .chat-discovery-card::after {
      content: "\2022 \2022 \2022";
      position: absolute;
      bottom: 0.3rem;
      right: 0.6rem;
      font-size: 0.5rem;
      color: rgba(212,160,80,0.2);
      letter-spacing: 0.2em;
    }
    .discovery-card-icon {
      float: left;
      margin-right: 0.5rem;
      margin-top: 0.1rem;
      color: var(--noir-amber);
    }
    .discovery-card-label {
      font-size: 0.65rem; font-weight: 700;
      text-transform: uppercase; letter-spacing: 0.1em;
      color: var(--noir-amber); margin-bottom: 0.15rem;
      font-family: var(--font-noir);
    }
    .discovery-card-text {
      font-size: 0.8rem; color: var(--noir-text-dim); line-height: 1.5;
      font-family: var(--font-body-serif);
    }
    @keyframes discoveryReveal {
      0%   { opacity: 0; transform: translateY(8px); border-left-color: transparent; }
      50%  { border-left-color: var(--noir-amber); }
      100% { opacity: 1; transform: none; }
    }

    /* ── Tab flash + badge for case board updates ─────── */
    .tab-flash {
      color: var(--gold) !important;
      animation: tabPulse 0.8s ease 3 !important;
    }
    @keyframes tabPulse {
      0%, 100% { color: var(--gold); text-shadow: none; }
      50% { color: var(--accent); text-shadow: 0 0 8px rgba(212,160,80,0.4); }
    }
    .tab-badge {
      display: inline-flex; align-items: center; justify-content: center;
      min-width: 20px; height: 20px;
      border-radius: 10px;
      background: var(--accent);
      color: var(--bg-dark, #0e0c09);
      font-size: 0.7rem;
      font-weight: 700;
      padding: 0 5px;
      margin-left: 0.4rem;
      vertical-align: middle;
      animation: gauge-pulse 0.6s ease;
    }

    /* ── Discovery exclamation on chat messages ─────────── */
    .msg-has-discovery {
      border-color: rgba(212,160,80,0.35);
    }
    .msg-discovery-icon {
      position: absolute;
      top: -6px; right: -6px;
      width: 20px; height: 20px;
      border-radius: 50%;
      background: var(--accent);
      color: var(--bg-dark, #0e0c09);
      font-size: 0.7rem;
      font-weight: 700;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      animation: gauge-pulse 0.6s ease;
    }

    /* ── Discovery toast notifications ──────────────────── */
    #discovery-toast-container {
      position: fixed;
      top: 60px; right: 16px;
      z-index: 11000;
      display: flex; flex-direction: column; gap: 8px;
      pointer-events: none;
    }
    .discovery-toast {
      pointer-events: auto;
      display: flex; align-items: flex-start; gap: 0.6rem;
      background: var(--bg-card, #1e1a14);
      border: 1.5px solid rgba(212,160,80,0.5);
      border-left: 4px solid var(--accent);
      border-radius: 8px;
      padding: 0.75rem 1rem;
      max-width: 340px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.5);
      animation: toastSlideIn 0.4s ease forwards;
      opacity: 1;
      transition: opacity 0.3s ease, transform 0.3s ease;
    }
    .discovery-toast.hiding {
      opacity: 0;
      transform: translateX(20px);
    }
    .discovery-toast-icon {
      flex-shrink: 0;
      width: 28px; height: 28px;
      border-radius: 50%;
      background: rgba(212,160,80,0.15);
      display: flex; align-items: center; justify-content: center;
      color: var(--accent);
      font-size: 0.9rem;
    }
    .discovery-toast-body { flex: 1; }
    .discovery-toast-heading {
      font-family: var(--font-typewriter);
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--accent);
      margin-bottom: 0.2rem;
    }
    .discovery-toast-text {
      font-size: 0.82rem;
      color: var(--text);
      line-height: 1.5;
    }
    @keyframes toastSlideIn {
      from { opacity: 0; transform: translateX(40px); }
      to   { opacity: 1; transform: translateX(0); }
    }

    /* ── NPC discovery badge ────────────────────────────── */
    .npc-card-discovery-badge {
      position: absolute;
      top: 6px; right: 6px;
      width: 20px; height: 20px;
      border-radius: 50%;
      background: var(--accent);
      color: var(--bg-dark, #0e0c09);
      font-size: 0.7rem;
      font-weight: 700;
      display: flex; align-items: center; justify-content: center;
      z-index: 3;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      animation: gauge-pulse 0.6s ease;
    }

    /* ── Interrogation Icon Gauges ──────────────────────── */
    .interrogation-gauges {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1.5rem;
    }
    .gauge {
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      flex-shrink: 0;
    }
    .gauge-icon {
      width: 96px;
      height: 96px;
      object-fit: contain;
      filter: none;
      transition: filter 0.4s ease;
    }
    /* Pressure glow: none at calm → increasingly intense red */
    .gauge-pressure.calm .gauge-icon     { filter: none; }
    .gauge-pressure.tense .gauge-icon    { filter: drop-shadow(0 0 6px rgba(220,60,60,0.3)) drop-shadow(0 0 12px rgba(220,60,60,0.1)); }
    .gauge-pressure.shaken .gauge-icon   { filter: drop-shadow(0 0 10px rgba(220,40,40,0.5)) drop-shadow(0 0 22px rgba(220,40,40,0.2)); }
    .gauge-pressure.cornered .gauge-icon { filter: drop-shadow(0 0 14px rgba(230,30,30,0.7)) drop-shadow(0 0 30px rgba(230,30,30,0.3)); }
    /* Rapport glow: none at cold → increasingly golden */
    .gauge-rapport.cold .gauge-icon      { filter: none; }
    .gauge-rapport.neutral .gauge-icon   { filter: drop-shadow(0 0 6px rgba(251,191,36,0.25)) drop-shadow(0 0 12px rgba(251,191,36,0.1)); }
    .gauge-rapport.open .gauge-icon      { filter: drop-shadow(0 0 10px rgba(251,191,36,0.5)) drop-shadow(0 0 22px rgba(251,191,36,0.2)); }
    .gauge-rapport.trusting .gauge-icon  { filter: drop-shadow(0 0 14px rgba(251,191,36,0.7)) drop-shadow(0 0 30px rgba(251,191,36,0.3)); }
    /* Continuous throb when gauge is maxed */
    @keyframes gauge-throb {
      0%   { transform: scale(1); }
      50%  { transform: scale(1.06); }
      100% { transform: scale(1); }
    }
    .gauge-pressure.cornered .gauge-icon { animation: gauge-throb 1.5s ease-in-out infinite; }
    .gauge-rapport.trusting .gauge-icon  { animation: gauge-throb 1.5s ease-in-out infinite; }
    /* Pulse animation on state change (overrides throb) */
    .gauge-icon.pulse {
      animation: gauge-pulse 0.6s ease !important;
    }
    @keyframes gauge-pulse {
      0%   { transform: scale(1); }
      50%  { transform: scale(1.12); }
      100% { transform: scale(1); }
    }
    /* ── Lila Hint Button (replaces gauges for partner) ── */
    .lila-hint-btn {
      display: none;
      align-items: center; gap: 0.5rem;
      font-family: var(--font-typewriter);
      font-size: 0.82rem; font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.08em;
      padding: 0.65rem 1.4rem;
      border: 1.5px solid rgba(212,160,80,0.4);
      border-radius: 8px;
      background: rgba(212,160,80,0.1);
      color: var(--accent);
      cursor: pointer;
      transition: background 0.2s, border-color 0.2s;
    }
    .lila-hint-btn:hover {
      background: rgba(212,160,80,0.22);
      border-color: var(--accent);
    }
    .lila-hint-btn svg { width: 16px; height: 16px; fill: currentColor; flex-shrink: 0; }
    .lila-hint-btn.visible { display: flex; }

    /* ── Endgame Modal ───────────────────────────────────── */
    #case-ready-modal {
      display: none;
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.75);
      z-index: 9999;
      align-items: center;
      justify-content: center;
    }
    #case-ready-modal.visible { display: flex; }
    .case-ready-card {
      background: var(--bg-panel);
      border: 1px solid var(--gold);
      border-radius: 1rem;
      padding: 2rem;
      max-width: 480px;
      text-align: center;
    }
    .case-ready-card h2 {
      font-family: var(--font-noir);
      color: var(--gold);
      margin-bottom: 0.75rem;
    }
    .case-ready-card p {
      color: var(--text-dim);
      margin-bottom: 1.5rem;
      line-height: 1.5;
    }
    .case-ready-actions {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .case-ready-actions button {
      padding: 0.65rem 1.2rem;
      border-radius: 0.5rem;
      border: 1px solid var(--border);
      background: var(--bg-input);
      color: var(--text);
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.2s;
    }
    .case-ready-actions button:first-child {
      background: var(--gold);
      color: #1a1a1a;
      border-color: var(--gold);
      font-weight: 600;
    }
    .case-ready-actions button:hover {
      filter: brightness(1.15);
    }

    /* Evidence group headers */
    .evidence-group-header {
      font-family: var(--font-noir);
      font-size: 0.72rem;
      font-weight: 700;
      color: var(--gold);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      padding: 0.75rem 0 0.25rem;
      border-bottom: 1px solid rgba(212,160,80,0.2);
      margin-bottom: 0.4rem;
    }
    .evidence-accuse-cta {
      display: block;
      width: 100%;
      margin-top: 1rem;
      padding: 0.7rem;
      border-radius: 0.5rem;
      border: 2px solid var(--danger);
      background: rgba(248,113,113,0.1);
      color: var(--danger);
      font-weight: 600;
      font-size: 0.85rem;
      cursor: pointer;
      transition: background 0.2s;
    }
    .evidence-accuse-cta:hover {
      background: rgba(248,113,113,0.2);
    }

    /* Chat right column */
    .chat-right-col {
      display: flex;
      flex-direction: column;
      min-height: 0;
      overflow: hidden;
      background: var(--noir-warm);
    }

    /* ── Chat Messages ─────────────────────────────────────── */
    .chat-messages-area {
      flex: 1;
      min-height: 0;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .chat-messages {
      flex: 1;
      min-height: 0;
      overflow-y: auto;
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1.1rem;
      background:
        linear-gradient(180deg, var(--noir-warm) 0%, transparent 120px, transparent calc(100% - 120px), var(--noir-warm) 100%),
        radial-gradient(ellipse 60% 40% at 15% 10%, rgba(212,160,80,0.06) 0%, transparent 70%),
        url("data:image/svg+xml,%3Csvg width='60' height='60' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 60L60 0M-5 5L5 -5M55 65L65 55' stroke='%23ffffff' stroke-opacity='0.02' stroke-width='0.5' fill='none'/%3E%3C/svg%3E"),
        url("data:image/svg+xml,%3Csvg width='4' height='4' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='1' height='1' x='1' y='1' fill='%23ffffff' fill-opacity='0.015'/%3E%3C/svg%3E"),
        var(--noir-warm);
    }
    .msg {
      position: relative;
      max-width: 75%;
      padding: 0.8rem 1rem;
      border-radius: 12px;
      font-size: 0.9rem;
      line-height: 1.6;
      animation: fadeIn 0.2s ease;
    }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: none; } }
    .msg.user {
      align-self: flex-end;
      max-width: 72%;
      background: linear-gradient(135deg, rgba(42,35,25,0.9), rgba(50,40,28,0.85));
      border: 1px solid rgba(212,160,80,0.18);
      border-right: 3px solid rgba(212,160,80,0.25);
      border-radius: 10px 2px 2px 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.35);
      font-family: var(--font-typewriter);
      color: var(--noir-text-dim);
      font-size: 0.88rem;
      line-height: 1.65;
      letter-spacing: 0.01em;
      position: relative;
      padding: 0.8rem 1rem 0.8rem 1.1rem;
    }
    .msg.user::after {
      content: "";
      position: absolute;
      top: 0; right: 0;
      width: 12px; height: 12px;
      background: linear-gradient(225deg, var(--noir-warm) 50%, rgba(212,160,80,0.15) 50%);
      border-radius: 0 2px 0 0;
      pointer-events: none;
    }
    .msg.assistant {
      align-self: flex-start;
      max-width: 78%;
      background: linear-gradient(135deg, rgba(44,36,25,0.95), rgba(35,30,23,0.9));
      border: 1px solid rgba(212,160,80,0.12);
      border-left: 3px solid var(--noir-amber-border);
      border-radius: 2px 10px 10px 2px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.03), inset 0 0 20px rgba(212,160,80,0.03);
      font-family: var(--font-body-serif);
      color: var(--noir-text);
      font-size: 0.9rem;
      line-height: 1.7;
      position: relative;
      padding: 1rem 1.1rem 0.9rem 1.3rem;
    }
    .msg .msg-sender {
      font-family: var(--font-noir);
      font-size: 0.72rem; font-weight: 700;
      text-transform: uppercase; letter-spacing: 0.14em;
      margin-bottom: 0.5rem; padding-bottom: 0.35rem;
      border-bottom: 1px solid rgba(212,160,80,0.15);
      color: var(--noir-text-faint);
      display: flex; align-items: center; gap: 0.4rem;
    }
    .msg.assistant .msg-sender {
      color: var(--noir-amber);
      border-bottom-color: var(--noir-amber-border);
    }
    .msg.assistant .msg-sender::before {
      content: "\2014";
      color: rgba(212,160,80,0.4);
      font-weight: 400;
    }
    .msg.user .msg-sender {
      color: rgba(232,220,200,0.5);
      border-bottom-color: rgba(232,220,200,0.1);
    }
    .msg.user .msg-sender::before {
      content: "\270E";
      font-size: 0.8rem;
      color: rgba(232,220,200,0.3);
    }
    .typing-indicator {
      align-self: flex-start;
      padding: 0.75rem 1.1rem;
      background: rgba(44,36,25,0.8);
      border: 1px solid rgba(212,160,80,0.12);
      border-left: 3px solid var(--noir-amber-border);
      border-radius: 2px 10px 10px 2px;
      display: none;
    }
    .typing-indicator.visible { display: flex; gap: 5px; align-items: center; }
    .typing-dot {
      width: 5px; height: 5px;
      border-radius: 50%;
      background: var(--noir-amber);
      animation: typingPulse 1.4s infinite;
    }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typingPulse {
      0%, 60%, 100% { opacity: 0.25; transform: scale(0.8); }
      30% { opacity: 1; transform: scale(1.1); }
    }

    /* Conversation starters */
    .chat-starters {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 2rem;
      max-width: 480px;
      margin: 0 auto;
      animation: fadeIn 0.4s ease;
    }
    .chat-starter-btn {
      width: 100%;
      background: rgba(212,160,80,0.04);
      border: 1px solid rgba(212,160,80,0.12);
      border-left: 2px solid rgba(212,160,80,0.25);
      border-radius: 2px 8px 8px 2px;
      color: var(--noir-text-dim);
      font-size: 0.82rem;
      padding: 0.65rem 1rem;
      cursor: pointer;
      text-align: left;
      transition: border-color 0.2s, color 0.2s, background 0.2s;
      line-height: 1.35;
      font-family: var(--font-body-serif);
      font-style: italic;
    }
    .chat-starter-btn:hover {
      border-color: var(--noir-amber);
      border-left-color: var(--noir-amber);
      color: var(--noir-text);
      background: rgba(212,160,80,0.08);
    }

    /* Chat input */
    .chat-input-bar {
      display: none;
      padding: 0.85rem 1.5rem;
      background: linear-gradient(0deg, var(--noir-panel) 60%, var(--noir-panel-alt));
      border-top: 1px solid rgba(212,160,80,0.15);
      gap: 0.75rem; align-items: flex-end;
      flex-shrink: 0;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.3);
    }
    .chat-input-bar.active { display: flex; }
    #chat-input {
      flex: 1;
      background: var(--noir-warm);
      border: 1px solid rgba(212,160,80,0.12);
      border-radius: 6px;
      padding: 0.75rem 1rem;
      color: var(--noir-text);
      font-size: 0.88rem;
      font-family: var(--font-typewriter);
      resize: none;
      max-height: 120px;
      min-height: 42px;
      line-height: 1.6;
      transition: border-color 0.15s, box-shadow 0.15s;
    }
    #chat-input:focus { outline: none; border-color: var(--noir-amber); box-shadow: 0 0 0 2px rgba(212,160,80,0.1), inset 0 0 12px rgba(212,160,80,0.03); }
    #chat-input::placeholder { color: var(--noir-text-faint); font-style: italic; font-family: var(--font-body-serif); }
    #send-btn {
      width: 42px; height: 42px;
      border: none; border-radius: 8px;
      background: linear-gradient(135deg, var(--noir-amber), #b8862e);
      color: #1a1510;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0;
      transition: transform 0.1s, box-shadow 0.15s;
      box-shadow: 0 2px 8px rgba(212,160,80,0.2);
    }
    #send-btn:hover { transform: scale(1.05); box-shadow: 0 4px 14px rgba(212,160,80,0.35); }
    #send-btn:disabled { opacity: 0.3; cursor: not-allowed; transform: none; box-shadow: none; }
    #send-btn svg { width: 18px; height: 18px; }
    #cancel-btn {
      display: none;
      width: 42px; height: 42px;
      border: none; border-radius: 8px;
      background: linear-gradient(135deg, var(--danger), #c05050);
      color: #fff;
      cursor: pointer;
      align-items: center; justify-content: center;
      flex-shrink: 0;
      transition: transform 0.1s, box-shadow 0.15s;
      box-shadow: 0 2px 8px rgba(248,113,113,0.25);
    }
    #cancel-btn:hover { transform: scale(1.05); box-shadow: 0 4px 14px rgba(248,113,113,0.4); }
    #cancel-btn svg { width: 16px; height: 16px; }
    #cancel-btn.visible { display: flex; }
    .chat-input-bar.cancellable #send-btn { display: none; }
    .chat-input-bar.cancellable #cancel-btn { display: flex; }

    /* ── Clue Items (reused in case board) ─────────────────── */
    .clue-item {
      background: var(--bg-dark);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 0.75rem;
      margin-bottom: 0.5rem;
      animation: fadeIn 0.3s ease;
    }
    .clue-item .clue-label {
      font-family: var(--font-noir);
      font-size: 0.75rem; font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.06em;
      color: var(--gold);
      margin-bottom: 0.25rem;
    }
    .clue-item .clue-text {
      font-size: 0.82rem;
      color: var(--text-dim);
      line-height: 1.5;
    }
    .clue-discoveries {
      margin-top: 0.4rem;
      padding-top: 0.4rem;
      border-top: 1px solid var(--border);
    }
    .clue-discovery-item {
      font-size: 0.76rem;
      color: var(--text-dim);
      line-height: 1.4;
      padding: 0.25rem 0 0.25rem 0.6rem;
      border-left: 2px solid var(--accent);
      margin-bottom: 0.25rem;
    }
    .empty-state {
      text-align: center;
      padding: 2rem 1rem;
      color: var(--text-faint);
      font-size: 0.85rem;
      font-style: italic;
    }

    /* ── Keycard Logs Terminal Modal ──────────────────────── */
    .clue-view-logs-btn {
      display: inline-flex; align-items: center; gap: 0.3rem;
      margin-top: 0.5rem;
      padding: 0.35rem 0.7rem;
      background: transparent;
      border: 1px solid rgba(212,160,80,0.3);
      border-radius: 4px;
      color: var(--noir-amber, #d4a050);
      font-family: var(--font-typewriter, "Courier New", monospace);
      font-size: 0.68rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      cursor: pointer;
      transition: background 0.2s, border-color 0.2s, color 0.2s;
    }
    .clue-view-logs-btn:hover {
      background: rgba(212,160,80,0.1);
      border-color: rgba(212,160,80,0.6);
      color: #e8c06a;
    }

    #keycard-modal {
      position: fixed; inset: 0; z-index: 210;
      display: none; align-items: center; justify-content: center;
      background: rgba(0,0,0,0.8);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
    }
    #keycard-modal.visible { display: flex; }

    .keycard-terminal {
      width: min(900px, 94vw);
      max-height: 88vh;
      display: flex;
      flex-direction: column;
      background: #0a0e08;
      border: 1px solid rgba(80,200,80,0.2);
      border-radius: 6px;
      box-shadow: 0 0 40px rgba(0,0,0,0.7), inset 0 0 80px rgba(40,120,40,0.03);
      overflow: hidden;
      position: relative;
    }
    /* CRT scanline overlay */
    .keycard-terminal::before {
      content: "";
      position: absolute; inset: 0;
      background: repeating-linear-gradient(
        0deg,
        transparent 0px,
        transparent 2px,
        rgba(0,0,0,0.08) 2px,
        rgba(0,0,0,0.08) 4px
      );
      pointer-events: none;
      z-index: 1;
    }

    .keycard-terminal-bar {
      display: flex; align-items: center; justify-content: space-between;
      padding: 0.6rem 1rem;
      background: linear-gradient(180deg, #141a10, #0e1309);
      border-bottom: 1px solid rgba(80,200,80,0.15);
      flex-shrink: 0;
    }
    .keycard-terminal-title {
      font-family: var(--font-mono);
      font-size: 0.72rem;
      color: rgba(120,220,100,0.8);
      letter-spacing: 0.12em;
      text-transform: uppercase;
    }
    .keycard-terminal-title::after {
      content: "█";
      margin-left: 0.4rem;
      animation: termBlink 1s step-end infinite;
      color: rgba(120,220,100,0.5);
    }
    @keyframes termBlink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0; }
    }
    .keycard-terminal-close {
      background: none; border: 1px solid rgba(120,220,100,0.2);
      color: rgba(120,220,100,0.6);
      font-size: 1rem; width: 28px; height: 28px;
      border-radius: 4px; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: color 0.15s, border-color 0.15s;
    }
    .keycard-terminal-close:hover {
      color: rgba(120,220,100,0.9);
      border-color: rgba(120,220,100,0.5);
    }

    .keycard-terminal-info {
      padding: 0.4rem 1rem;
      font-family: var(--font-mono);
      font-size: 0.62rem;
      color: rgba(120,220,100,0.4);
      letter-spacing: 0.1em;
      text-transform: uppercase;
      border-bottom: 1px solid rgba(80,200,80,0.08);
      flex-shrink: 0;
    }

    .keycard-terminal-body {
      flex: 1;
      overflow-y: auto;
      padding: 0.5rem 0;
      scrollbar-width: thin;
      scrollbar-color: rgba(80,200,80,0.2) transparent;
    }
    .keycard-terminal-body::-webkit-scrollbar { width: 6px; }
    .keycard-terminal-body::-webkit-scrollbar-thumb { background: rgba(80,200,80,0.2); border-radius: 3px; }

    .kc-row {
      display: grid;
      grid-template-columns: 70px 110px 90px 1fr 50px 64px;
      gap: 0.3rem;
      padding: 0.25rem 1rem;
      font-family: var(--font-mono);
      font-size: 0.68rem;
      line-height: 1.6;
      color: rgba(180,210,170,0.7);
      border-bottom: 1px solid rgba(80,200,80,0.04);
    }
    .kc-row:nth-child(even) { background: rgba(80,200,80,0.02); }
    .kc-row:hover { background: rgba(80,200,80,0.06); }

    .kc-time { color: rgba(120,220,100,0.5); }
    .kc-zone { color: rgba(100,200,120,0.8); font-weight: 600; }
    .kc-card { color: rgba(180,210,170,0.45); }
    .kc-holder { color: rgba(200,220,190,0.8); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .kc-dir { text-transform: uppercase; font-size: 0.6rem; }
    .kc-dir.entry { color: rgba(100,200,120,0.6); }
    .kc-dir.exit { color: rgba(200,180,100,0.6); }
    .kc-access { font-size: 0.6rem; text-transform: uppercase; color: rgba(100,200,120,0.4); }

    .kc-system {
      display: block;
      padding: 0.5rem 1rem;
      margin: 0.3rem 0.5rem;
      font-family: var(--font-mono);
      font-size: 0.68rem;
      line-height: 1.5;
      border-radius: 3px;
      border-left: 3px solid;
    }
    .kc-system.offline {
      background: rgba(220,60,40,0.08);
      border-left-color: rgba(220,60,40,0.6);
      color: rgba(255,140,120,0.9);
    }
    .kc-system.restored {
      background: rgba(80,200,80,0.06);
      border-left-color: rgba(80,200,80,0.5);
      color: rgba(120,220,100,0.8);
    }
    .kc-system-icon { margin-right: 0.4rem; }
    .kc-system-time { opacity: 0.6; }

    .kc-header {
      display: grid;
      grid-template-columns: 70px 110px 90px 1fr 50px 64px;
      gap: 0.3rem;
      padding: 0.35rem 1rem;
      font-family: var(--font-mono);
      font-size: 0.58rem;
      color: rgba(120,220,100,0.35);
      letter-spacing: 0.06em;
      text-transform: uppercase;
      border-bottom: 1px solid rgba(80,200,80,0.12);
    }

    @media (max-width: 600px) {
      .kc-row, .kc-header {
        grid-template-columns: 58px 80px 1fr 42px;
        font-size: 0.6rem;
      }
      .kc-card, .kc-access { display: none; }
      .keycard-terminal { width: 98vw; max-height: 92vh; }
    }

    /* ── Accusation Modal ──────────────────────────────────── */
    #accusation-modal {
      position: fixed; inset: 0; z-index: 200;
      display: none; align-items: center; justify-content: center;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(4px);
    }
    #accusation-modal.visible { display: flex; }
    .modal-card {
      background: var(--bg-panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 2rem;
      width: min(500px, 90vw);
      box-shadow: 0 32px 64px rgba(0,0,0,0.5);
    }
    .modal-card h2 {
      font-family: var(--font-noir);
      font-size: 1.2rem; font-weight: 700;
      text-transform: uppercase; letter-spacing: 0.06em;
      margin-bottom: 0.5rem;
      color: var(--danger);
    }
    .modal-card p {
      font-size: 0.88rem; color: var(--text-dim);
      line-height: 1.6;
      margin-bottom: 1.25rem;
    }
    .suspect-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
    }
    .suspect-option {
      padding: 0.7rem;
      background: var(--bg-dark);
      border: 2px solid var(--border);
      border-radius: 8px;
      cursor: pointer;
      text-align: center;
      font-size: 0.85rem; font-weight: 500;
      transition: border-color 0.15s, background 0.15s;
      display: flex; flex-direction: column; align-items: center; gap: 0.25rem;
    }
    .suspect-option:hover { border-color: var(--text-faint); }
    .suspect-option.selected { border-color: var(--danger); background: rgba(248,113,113,0.1); }
    .suspect-option img.suspect-portrait {
      width: 48px; height: 48px;
      border-radius: 50%;
      object-fit: cover;
      margin-bottom: 0.3rem;
    }
    .modal-actions {
      display: flex; gap: 0.75rem; justify-content: flex-end;
    }
    .modal-actions button {
      padding: 0.6rem 1.5rem;
      border-radius: 8px;
      font-size: 0.85rem; font-weight: 600;
      cursor: pointer;
      border: none;
    }
    #cancel-accuse {
      background: var(--bg-input);
      color: var(--text-dim);
      border: 1px solid var(--border);
    }
    #confirm-accuse {
      background: var(--danger);
      color: #fff;
    }
    #confirm-accuse:disabled { opacity: 0.4; cursor: not-allowed; }

    /* ── Outcome Screen ────────────────────────────────────── */
    #outcome-screen {
      position: fixed; inset: 0; z-index: 300;
      display: none; align-items: center; justify-content: center;
      background: rgba(0,0,0,0.85);
      backdrop-filter: blur(8px);
    }
    #outcome-screen.visible { display: flex; }
    .outcome-card {
      max-width: 520px; width: 90vw;
      background: var(--bg-panel);
      border-radius: 16px;
      padding: 2.5rem;
      text-align: center;
      box-shadow: 0 32px 64px rgba(0,0,0,0.6);
    }
    .outcome-card h2 {
      font-family: var(--font-noir);
      font-size: 1.8rem; font-weight: 700;
      margin-bottom: 0.5rem;
    }
    .outcome-card.correct h2 { color: var(--success); }
    .outcome-card.wrong h2 { color: var(--danger); }
    .outcome-card .outcome-text {
      font-size: 0.95rem;
      color: var(--text-dim);
      line-height: 1.7;
      margin-bottom: 2rem;
    }
    #restart-btn {
      font-family: var(--font-noir);
      background: linear-gradient(120deg, var(--noir-amber), #b8862e);
      border: none; border-radius: 10px;
      padding: 0.8rem 2rem;
      font-size: 0.95rem; font-weight: 600;
      color: #1a1510; cursor: pointer;
      text-transform: uppercase; letter-spacing: 0.06em;
    }

    /* ── Scrollbar Styling ─────────────────────────────────── */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(212,160,80,0.15); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(212,160,80,0.3); }

    /* ── Language Toggle ──────────────────────────────────── */
    .lang-toggle {
      display: inline-flex;
      border-radius: 6px;
      overflow: hidden;
      border: 1px solid var(--border);
    }
    .lang-btn {
      padding: 0.3rem 0.65rem;
      font-size: 0.72rem; font-weight: 600;
      letter-spacing: 0.04em;
      background: var(--bg-input);
      color: var(--text-faint);
      border: none; cursor: pointer;
      transition: background 0.15s, color 0.15s;
    }
    .lang-btn.active {
      background: var(--noir-amber);
      color: #1a1510;
    }
    .lang-btn:not(.active):hover {
      background: var(--bg-panel-alt);
      color: var(--text);
    }

    /* ── Voice: Mic Button ──────────────────────────────── */
    #mic-btn {
      width: 42px; height: 42px;
      border: 1px solid rgba(212,160,80,0.15);
      border-radius: 8px;
      background: var(--noir-input);
      color: var(--noir-text-faint);
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0;
      transition: background 0.15s, color 0.15s, border-color 0.15s;
    }
    #mic-btn:hover { color: var(--noir-text); border-color: var(--noir-text-faint); }
    #mic-btn.recording {
      background: rgba(248,113,113,0.15);
      border-color: var(--danger);
      color: var(--danger);
      animation: micPulse 1.5s infinite;
    }
    #mic-btn.processing {
      color: var(--accent);
      border-color: var(--accent);
      cursor: wait;
    }
    #mic-btn.voice-mode {
      background: rgba(212,160,80,0.12);
      border-color: var(--noir-amber);
      color: var(--noir-amber);
    }
    #mic-btn.voice-mode.recording {
      background: rgba(248,113,113,0.15);
      border-color: var(--danger);
      color: var(--danger);
    }
    #mic-btn.voice-mode.waiting {
      background: rgba(212,160,80,0.12);
      border-color: var(--noir-amber);
      color: var(--noir-amber);
      opacity: 0.6;
      cursor: default;
    }
    #mic-btn svg { width: 18px; height: 18px; }
    @keyframes micPulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(248,113,113,0.4); }
      50% { box-shadow: 0 0 0 8px rgba(248,113,113,0); }
    }

    /* ── Voice: Audio Toggle ────────────────────────────── */
    #audio-toggle.active {
      color: var(--accent);
      background: var(--manila-tab-active);
    }
    /* ── Settings Modal ────────────────────────────────── */
    #settings-modal {
      position: fixed; inset: 0; z-index: 250;
      display: none; align-items: center; justify-content: center;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(4px);
    }
    #settings-modal.visible { display: flex; }
    .settings-card {
      background: var(--bg-panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      width: 90%; max-width: 360px;
      overflow: hidden;
    }
    .settings-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 1rem 1.25rem;
      border-bottom: 1px solid var(--border);
    }
    .settings-header h2 {
      font-family: var(--font-noir);
      font-size: 1rem; font-weight: 600;
      color: var(--text); margin: 0;
    }
    .settings-close-btn {
      background: none; border: none;
      color: var(--text-faint); font-size: 1.4rem;
      cursor: pointer; line-height: 1;
      padding: 0 0.2rem;
      transition: color 0.15s;
    }
    .settings-close-btn:hover { color: var(--text); }
    .settings-body { padding: 1rem 1.25rem; }
    .settings-row { margin-bottom: 0.75rem; }
    .settings-lang-row {
      display: flex; align-items: center; justify-content: space-between;
    }
    .settings-label {
      font-size: 0.85rem; font-weight: 600; color: var(--text-dim);
    }
    .settings-row:last-child { margin-bottom: 0; }
    .settings-danger-btn {
      width: 100%; padding: 0.65rem;
      border: 1px solid rgba(248,113,113,0.4);
      border-radius: 8px;
      background: rgba(248,113,113,0.1);
      color: var(--danger);
      font-size: 0.8rem; font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.06em;
      cursor: pointer;
      transition: background 0.15s, border-color 0.15s;
    }
    .settings-danger-btn:hover {
      background: rgba(248,113,113,0.2);
      border-color: var(--danger);
    }
    .settings-cancel-btn {
      padding: 0.5rem 1rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--bg-input);
      color: var(--text-dim);
      font-size: 0.8rem; font-weight: 600;
      cursor: pointer;
      transition: background 0.15s, border-color 0.15s;
    }
    .settings-cancel-btn:hover {
      background: var(--bg-panel-alt);
      border-color: var(--text-dim);
    }
    .settings-confirm {
      background: var(--bg-dark);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 0.85rem;
      animation: fadeIn 0.2s ease;
    }
    .settings-confirm p {
      color: var(--text-dim); font-size: 0.82rem;
      margin: 0 0 0.75rem; line-height: 1.4;
    }
    .settings-confirm-actions {
      display: flex; gap: 0.5rem; justify-content: flex-end;
    }
    .settings-confirm-actions .settings-danger-btn {
      width: auto; padding: 0.5rem 1rem;
    }

    /* ── Auth Modal ────────────────────────────────────── */
    #auth-modal {
      position: fixed; inset: 0; z-index: 260;
      display: none; align-items: center; justify-content: center;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(4px);
    }
    #auth-modal.visible { display: flex; }
    .auth-card {
      background: var(--bg-panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      width: 90%; max-width: 380px;
      overflow: hidden;
    }
    .auth-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 1rem 1.25rem;
      border-bottom: 1px solid var(--border);
    }
    .auth-header h2 {
      font-family: var(--font-noir);
      font-size: 1rem; font-weight: 600;
      color: var(--text); margin: 0;
    }
    .auth-close-btn {
      background: none; border: none;
      color: var(--text-faint); font-size: 1.4rem;
      cursor: pointer; line-height: 1;
      padding: 0 0.2rem;
      transition: color 0.15s;
    }
    .auth-close-btn:hover { color: var(--text); }
    .auth-body { padding: 1.25rem; }
    .auth-tabs {
      display: flex; gap: 0; margin-bottom: 1rem;
      border-bottom: 1px solid var(--border);
    }
    .auth-tab-btn {
      flex: 1; padding: 0.6rem 0.5rem;
      background: none; border: none;
      border-bottom: 2px solid transparent;
      color: var(--text-faint);
      font-family: var(--font-noir);
      font-size: 0.85rem; font-weight: 600;
      cursor: pointer; transition: color 0.15s, border-color 0.15s;
      text-transform: uppercase; letter-spacing: 0.04em;
    }
    .auth-tab-btn.active {
      color: var(--noir-amber);
      border-bottom-color: var(--noir-amber);
    }
    .auth-tab-btn:hover { color: var(--text); }
    .auth-field { margin-bottom: 0.85rem; }
    .auth-field label {
      display: block;
      font-size: 0.78rem; font-weight: 600;
      color: var(--text-dim);
      margin-bottom: 0.3rem;
      text-transform: uppercase; letter-spacing: 0.04em;
    }
    .auth-field input {
      width: 100%; padding: 0.6rem 0.75rem;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 0.88rem;
      font-family: var(--font);
      transition: border-color 0.15s;
    }
    .auth-field input:focus {
      outline: none;
      border-color: var(--noir-amber);
    }
    .auth-submit-btn {
      width: 100%; padding: 0.7rem;
      border: none; border-radius: 8px;
      background: var(--noir-amber);
      color: var(--noir-warm);
      font-family: var(--font-noir);
      font-size: 0.85rem; font-weight: 700;
      text-transform: uppercase; letter-spacing: 0.06em;
      cursor: pointer;
      transition: background 0.15s, transform 0.1s;
    }
    .auth-submit-btn:hover {
      background: #b8862e;
      transform: translateY(-1px);
    }
    .auth-submit-btn:disabled {
      opacity: 0.5; cursor: not-allowed;
      transform: none;
    }
    .auth-error {
      color: var(--danger);
      font-size: 0.78rem;
      margin-bottom: 0.7rem;
      min-height: 1.2em;
    }
    .auth-info {
      color: var(--success);
      font-size: 0.78rem;
      margin-bottom: 0.7rem;
      min-height: 1.2em;
    }
    .auth-user-bar {
      display: flex; align-items: center; gap: 0.6rem;
      padding: 0.5rem 0;
    }
    .auth-user-email {
      font-size: 0.82rem;
      color: var(--text-dim);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      flex: 1;
    }
    .auth-logout-btn {
      padding: 0.35rem 0.7rem;
      border: 1px solid rgba(248,113,113,0.4);
      border-radius: 6px;
      background: rgba(248,113,113,0.1);
      color: var(--danger);
      font-size: 0.72rem; font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.04em;
      cursor: pointer;
      transition: background 0.15s;
    }
    .auth-logout-btn:hover { background: rgba(248,113,113,0.2); }
    .auth-status-pill {
      display: inline-flex; align-items: center; gap: 4px;
      padding: 0.2rem 0.5rem;
      border-radius: 10px;
      font-size: 0.68rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }
    .auth-status-pill.cloud {
      background: rgba(168,184,142,0.15);
      color: var(--success);
    }
    .auth-status-pill.local {
      background: rgba(212,160,80,0.12);
      color: var(--noir-amber);
    }
    .cloud-save-indicator {
      font-size: 0.72rem;
      color: var(--text-faint);
      text-align: center;
      padding: 0.5rem 0;
      min-height: 1.6em;
    }
    .cloud-save-indicator.saving { color: var(--noir-amber); }
    .cloud-save-indicator.saved { color: var(--success); }
    .cloud-save-indicator.error { color: var(--danger); }

    /* ── Voice: Per-message replay button ──────────────── */
    .msg-audio-btn {
      display: inline-flex; align-items: center; gap: 4px;
      margin-left: 0.5rem;
      padding: 0.15rem 0.4rem;
      border: 1px solid rgba(212,160,80,0.2);
      border-radius: 4px;
      background: transparent;
      color: var(--noir-text-faint);
      font-size: 0.72rem;
      cursor: pointer;
      transition: color 0.15s, border-color 0.15s;
      vertical-align: middle;
    }
    .msg-audio-btn:hover { color: var(--noir-amber); border-color: var(--noir-amber); }
    .msg-audio-btn.playing { color: var(--noir-amber); border-color: var(--noir-amber); }
    .msg-audio-btn svg { width: 12px; height: 12px; }

    /* ── Tutorial Coach Marks ────────────────────────────── */
    .tutorial-overlay {
      position: fixed; inset: 0; z-index: 10000;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .tutorial-overlay.active { opacity: 1; pointer-events: auto; }
    .tutorial-backdrop {
      position: absolute; inset: 0;
      background: rgba(10, 8, 5, 0.82);
      transition: clip-path 0.35s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .tutorial-tooltip {
      position: absolute;
      max-width: 340px;
      background: var(--noir-panel);
      border: 1.5px solid var(--noir-amber);
      border-radius: 10px;
      padding: 1.1rem 1.3rem 0.9rem;
      box-shadow: 0 8px 32px rgba(0,0,0,0.6), 0 0 0 1px rgba(212,160,80,0.1);
      font-family: var(--font-body-serif);
      color: var(--noir-text);
      z-index: 10001;
      transition: transform 0.3s ease, opacity 0.3s ease;
    }
    .tutorial-tooltip::before {
      content: "";
      position: absolute;
      width: 12px; height: 12px;
      background: var(--noir-panel);
      border: 1.5px solid var(--noir-amber);
      transform: rotate(45deg);
    }
    .tutorial-tooltip.arrow-top::before    { top: -7px; left: 24px; border-right: none; border-bottom: none; }
    .tutorial-tooltip.arrow-bottom::before { bottom: -7px; left: 24px; border-left: none; border-top: none; }
    .tutorial-tooltip.arrow-left::before   { left: -7px; top: 20px; border-top: none; border-right: none; }
    .tutorial-tooltip.arrow-right::before  { right: -7px; top: 20px; border-bottom: none; border-left: none; }
    .tutorial-text {
      font-size: 0.92rem;
      line-height: 1.5;
      margin-bottom: 0.9rem;
    }
    .tutorial-step-indicator {
      font-size: 0.72rem;
      color: var(--noir-text-faint);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 0.5rem;
      font-family: var(--font-noir);
    }
    .tutorial-actions {
      display: flex;
      gap: 0.6rem;
      justify-content: flex-end;
    }
    .tutorial-btn {
      padding: 0.4rem 1rem;
      border-radius: 6px;
      font-size: 0.8rem;
      font-weight: 700;
      font-family: var(--font-noir);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      cursor: pointer;
      transition: background 0.15s, transform 0.1s;
      border: none;
    }
    .tutorial-btn-skip {
      background: transparent;
      color: var(--noir-text-faint);
      border: 1px solid rgba(212,160,80,0.2);
    }
    .tutorial-btn-skip:hover { color: var(--noir-text-dim); border-color: rgba(212,160,80,0.4); }
    .tutorial-btn-next {
      background: linear-gradient(135deg, var(--noir-amber), #b8862e);
      color: #1a1510;
    }
    .tutorial-btn-next:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(212,160,80,0.3); }
    /* Pulsing ring overlay for click-to-advance targets */
    .tutorial-pulse-ring {
      position: fixed;
      border: 2.5px solid var(--noir-amber);
      border-radius: 10px;
      pointer-events: none;
      z-index: 10000;
      animation: tutorialPulse 1.4s ease-in-out infinite;
    }
    @keyframes tutorialPulse {
      0%   { opacity: 1; transform: scale(1); }
      50%  { opacity: 0.5; transform: scale(1.04); box-shadow: 0 0 18px rgba(212,160,80,0.5); }
      100% { opacity: 1; transform: scale(1); }
    }

    /* ── Responsive ────────────────────────────────────────── */
    @media (max-width: 900px) {
      .npc-row { flex-wrap: wrap; }
      .npc-card { width: 140px; }
    }
    @media (max-width: 768px) {
      .manila-tabs { padding: 0 0.75rem; padding-top: 0.5rem; }
      .manila-tab { min-width: auto; font-size: 0.65rem; padding: 0.55rem 0.7rem 0.45rem; }
      .manila-tab-icon { padding: 0.55rem 0.7rem; }
      .gauge-icon { width: 64px; height: 64px; }
      .portrait-nameplate-row { gap: 0.5rem; }
      #chat-input { font-family: var(--font-typewriter); }
      .chat-layout {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr;
      }
      .chat-portrait-panel {
        flex-direction: row;
        flex-wrap: wrap;
        border-right: none;
        border-bottom: 1px solid var(--border);
        max-height: 260px;
        overflow: hidden;
      }
      .portrait-frame { width: 130px; flex: none; height: 180px; min-height: unset; }
      .portrait-nameplate {
        flex: 1; min-width: 180px;
        display: flex; flex-direction: column; justify-content: center;
      }
    }
    @media (max-width: 600px) {
      .npc-card { width: 120px; }
    }
  </style>
</head>
<body>

<!-- ════════ Title Card ════════ -->
<div id="title-card" class="hidden">
  <div class="title-card-inner">
    <div class="title-card-classified">CLASSIFIED</div>
    <h1 class="title-card-stamp">Echoes in the Atrium</h1>
    <p class="title-card-subtitle" data-i18n="intro.subtitle">A Murder Mystery Investigation</p>
    <div class="title-card-meta">
      <span data-i18n="titlecard.case_number">Case #1247-B</span>
      <span>•</span>
      <span data-i18n="titlecard.division">Det. Division — Homicide</span>
    </div>
    <button class="title-card-open-btn" id="title-card-btn" data-i18n="titlecard.open">Open Case File</button>
  </div>
</div>

<!-- ════════ Auth Prompt (shown after title card, before game) ════════ -->
<div id="auth-prompt" class="hidden">
  <div class="auth-prompt-card">
    <h2 class="auth-prompt-heading">Save Your Progress</h2>
    <p class="auth-prompt-desc">Sign in to save your investigation to the cloud. Your progress will be safe across devices.</p>
    <div class="auth-prompt-buttons">
      <button class="auth-prompt-btn primary" id="auth-prompt-signin">Sign In</button>
      <button class="auth-prompt-btn primary" id="auth-prompt-signup">Create Account</button>
    </div>
    <button class="auth-prompt-skip" id="auth-prompt-skip">Continue without account</button>
    <p class="auth-prompt-warning">Progress will only be saved locally and may be lost.</p>
  </div>
</div>

<!-- ════════ Hub Screen ════════ -->
<div id="hub-screen">
  <div class="manila-tabs">
    <button class="manila-tab active" data-hub-tab="suspects">
      <span class="manila-tab-label" data-i18n="hub.tab_suspects">Persons of Interest</span>
    </button>
    <button class="manila-tab" data-hub-tab="caseboard">
      <span class="manila-tab-label" data-i18n="hub.tab_caseboard">Case Board</span>
    </button>
    <div class="manila-tabs-spacer"></div>
    <button class="manila-tab manila-tab-icon" id="hub-settings-tab" title="Settings">
      <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="3"></circle>
        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
      </svg>
    </button>
  </div>

  <div class="hub-content">
    <div class="hub-panel active" id="hub-suspects">
      <div class="npc-grid-container" id="npc-grid"></div>
    </div>
    <div class="hub-panel" id="hub-caseboard">
      <div class="caseboard-layout">
        <div class="caseboard-section caseboard-briefing-section">
          <button class="caseboard-briefing-toggle" id="cb-briefing-toggle" aria-expanded="false">
            <h3 class="caseboard-heading" style="margin-bottom:0; padding-bottom:0; border-bottom:none;">
              <span data-i18n="intro.briefing_label">Case Briefing</span>
              <svg class="cb-briefing-chevron" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </h3>
          </button>
          <div class="caseboard-briefing-body" id="cb-briefing-body">
            <p data-i18n="intro.victim" data-i18n-html><strong>Victim:</strong> Julian Mercer, charismatic venture capitalist, majority owner of the Lyric Atrium Hotel, and CEO of the Panopticon surveillance startup — found dead in the hotel's rooftop observatory.</p>
            <p data-i18n="intro.time_of_death" data-i18n-html><strong>Estimated Time of Death:</strong> Between 11:15 and 11:30 PM (during the power outage). The victim was bludgeoned with an antique telescope mount.</p>
            <p data-i18n="intro.body_discovered" data-i18n-html><strong>Body Discovered:</strong> Approximately 11:44 PM by Security Director Gideon Holt in the rooftop observatory, during an exclusive tech-meets-jazz gala at the historic 1920s art deco hotel.</p>
            <p data-i18n="intro.circumstances" data-i18n-html><strong>Circumstances:</strong> A power outage struck between 11:15 and 11:30 PM — the breaker was pulled manually. Stormy weather delayed police arrival, giving suspects time to coordinate alibis.</p>
            <p data-i18n="intro.starting_evidence" data-i18n-html><strong>Initial Evidence:</strong> Forensics recovered a <em>burned notebook fragment</em> and traces of <em>antique machine oil</em> near the body. Hotel security has also provided <em>keycard access logs</em> for the rooftop. Use these to press suspects during interrogation.</p>
            <p data-i18n="intro.your_role" data-i18n-html><strong>Your Role:</strong> You are the lead detective. Interrogate eight persons of interest — each with their own secrets, motives, and knowledge boundaries. Uncover contradictions, gather evidence, and identify the killer.</p>
            <p data-i18n="intro.your_partner" data-i18n-html><strong>Your Partner:</strong> Detective Lila Chen will assist with tactical advice and legal guidance. Start with her for an overview of the case.</p>
            <p style="margin-top:1rem; color: var(--gold);" data-i18n="intro.tip" data-i18n-html><strong>Tip:</strong> Suspects will guard their secrets carefully. Present evidence and build pressure to break through their defenses. Pay attention to contradictions between testimonies.</p>
          </div>
        </div>
        <div class="caseboard-section">
          <h3 class="caseboard-heading" data-i18n="evidence.tab">Evidence and Discoveries</h3>
          <div id="cb-evidence-empty" class="empty-state" data-i18n="evidence.empty">No evidence collected yet. Interrogate suspects to uncover clues.</div>
          <div id="cb-evidence-list"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ════════ Chat Screen ════════ -->
<div id="chat-screen">
  <div class="manila-tabs chat-manila-tabs">
    <button class="manila-tab" id="nav-to-suspects">
      <span class="manila-tab-label" data-i18n="chat.nav_suspects">Persons of Interest</span>
    </button>
    <button class="manila-tab" id="nav-to-caseboard">
      <span class="manila-tab-label" data-i18n="chat.nav_caseboard">Case Board</span>
    </button>
    <div class="manila-tabs-spacer"></div>
    <button class="manila-tab manila-tab-icon" id="audio-toggle" title="Toggle voice">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
        <path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path>
        <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>
      </svg>
    </button>
    <button class="manila-tab manila-tab-icon" id="chat-settings-tab" title="Settings">
      <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="3"></circle>
        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
      </svg>
    </button>
  </div>

  <div class="chat-layout">
    <div class="chat-portrait-panel" id="chat-portrait-panel">
      <div class="portrait-frame">
        <img id="chat-portrait-img" src="" alt="" />
        <button class="portrait-info-btn" id="portrait-info-btn" aria-label="NPC Bio">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor"
            stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"/>
            <line x1="12" y1="16" x2="12" y2="12"/>
            <line x1="12" y1="8" x2="12.01" y2="8"/>
          </svg>
        </button>
        <div class="portrait-bio-tooltip" id="portrait-bio-tooltip"></div>
      </div>
      <div class="portrait-nameplate">
        <div class="portrait-nameplate-row" id="interrogation-gauges">
          <div class="portrait-nameplate-info">
            <div class="portrait-name" id="portrait-name"></div>
            <div class="portrait-role" id="portrait-role"></div>
          </div>
          <div class="gauge gauge-pressure calm" id="gauge-pressure">
            <img class="gauge-icon" id="gauge-pressure-icon" src="icons/pressure-calm.png" alt="Pressure" />
          </div>
          <div class="gauge gauge-rapport neutral" id="gauge-rapport">
            <img class="gauge-icon" id="gauge-rapport-icon" src="icons/rapport-neutral.png" alt="Rapport" />
          </div>
          <button class="lila-hint-btn" id="lila-hint-btn">
            <svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor" stroke="none">
              <path d="M12 2C8.13 2 5 5.13 5 9c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-2.26c1.81-1.27 3-3.36 3-5.74 0-3.87-3.13-7-7-7zM9 21c0 .55.45 1 1 1h4c.55 0 1-.45 1-1v-1H9v1z"/>
            </svg>
            <span data-i18n="chat.hint_btn">Case Hint</span>
          </button>
        </div>
        <div class="portrait-status" id="portrait-status" style="display:none"></div>
      </div>

    </div>

    <div class="chat-right-col">
      <div class="chat-messages-area">
        <div class="chat-messages" id="chat-messages"></div>
        <div class="typing-indicator" id="typing-indicator">
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
        </div>
      </div>

      <div class="chat-input-bar active" id="chat-input-bar">
        <button id="mic-btn" title="Record voice message">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
            <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
            <line x1="12" y1="19" x2="12" y2="23"></line>
            <line x1="8" y1="23" x2="16" y2="23"></line>
          </svg>
        </button>
        <textarea id="chat-input" rows="1" placeholder="Type your question..." data-i18n-placeholder="chat.input_placeholder"></textarea>
        <button id="send-btn" disabled>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="22" y1="2" x2="11" y2="13"></line>
            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
          </svg>
        </button>
        <button id="cancel-btn" title="Cancel response">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <rect x="6" y="6" width="12" height="12" rx="2"></rect>
          </svg>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ════════ Tutorial Overlay ════════ -->
<div class="tutorial-overlay" id="tutorial-overlay">
  <div class="tutorial-backdrop" id="tutorial-backdrop"></div>
  <div class="tutorial-tooltip" id="tutorial-tooltip">
    <div class="tutorial-step-indicator" id="tutorial-step-indicator"></div>
    <div class="tutorial-text" id="tutorial-text"></div>
    <div class="tutorial-actions">
      <button class="tutorial-btn tutorial-btn-skip" id="tutorial-skip"></button>
      <button class="tutorial-btn tutorial-btn-next" id="tutorial-next"></button>
    </div>
  </div>
</div>

<!-- ════════ Settings Modal ════════ -->
<div id="settings-modal">
  <div class="settings-card">
    <div class="settings-header">
      <h2 data-i18n="settings.title">Settings</h2>
      <button id="settings-close" class="settings-close-btn">&times;</button>
    </div>
    <div class="settings-body">
      <div class="settings-row settings-lang-row">
        <label class="settings-label" data-i18n="settings.language">Language</label>
        <div class="lang-toggle">
          <button class="lang-btn active" data-lang="en">EN</button>
          <button class="lang-btn" data-lang="sr">SR</button>
        </div>
      </div>
      <div class="settings-row" id="settings-account-row">
        <button id="settings-account-btn" class="settings-cancel-btn" style="width:100%;">
          <span id="settings-account-label">Sign In / Create Account</span>
        </button>
      </div>
      <div class="settings-row" id="settings-logout-row" style="display:none;">
        <button id="settings-logout-btn" class="settings-danger-btn" style="width:100%;">Sign Out</button>
      </div>
      <div class="settings-row">
        <button id="settings-tutorial-btn" class="settings-cancel-btn" data-i18n="tutorial.replay" style="width:100%;">Replay Tutorial</button>
      </div>
      <div id="settings-restart-row" class="settings-row">
        <button id="settings-restart-btn" class="settings-danger-btn" data-i18n="settings.restart">Restart Investigation</button>
      </div>
      <div id="settings-restart-confirm" class="settings-confirm" style="display:none;">
        <p data-i18n="settings.restart_confirm">Are you sure? All progress will be lost.</p>
        <div class="settings-confirm-actions">
          <button id="settings-restart-cancel" class="settings-cancel-btn" data-i18n="settings.restart_cancel">Cancel</button>
          <button id="settings-restart-yes" class="settings-danger-btn" data-i18n="settings.restart_yes">Yes, restart</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ════════ Auth Modal ════════ -->
<div id="auth-modal">
  <div class="auth-card">
    <div class="auth-header">
      <h2 id="auth-modal-title">Sign In</h2>
      <button id="auth-close" class="auth-close-btn">&times;</button>
    </div>
    <div class="auth-body">
      <!-- Logged-out view -->
      <div id="auth-forms">
        <div class="auth-tabs">
          <button class="auth-tab-btn active" data-auth-tab="login">Sign In</button>
          <button class="auth-tab-btn" data-auth-tab="signup">Create Account</button>
        </div>
        <div class="auth-error" id="auth-error"></div>
        <div class="auth-info" id="auth-info"></div>
        <div class="auth-field">
          <label for="auth-email">Email</label>
          <input type="email" id="auth-email" placeholder="detective@example.com" autocomplete="email" />
        </div>
        <div class="auth-field">
          <label for="auth-password">Password</label>
          <input type="password" id="auth-password" placeholder="Min. 6 characters" autocomplete="current-password" />
        </div>
        <button id="auth-submit" class="auth-submit-btn">Sign In</button>
      </div>
      <!-- Logged-in view -->
      <div id="auth-logged-in" style="display:none;">
        <div class="auth-user-bar">
          <span class="auth-status-pill cloud">CLOUD SAVE</span>
          <span class="auth-user-email" id="auth-user-email"></span>
          <button id="auth-logout" class="auth-logout-btn">Sign Out</button>
        </div>
        <div class="cloud-save-indicator" id="cloud-save-indicator"></div>
      </div>
    </div>
  </div>
</div>

<!-- ════════ Accusation Modal ════════ -->
<div id="accusation-modal">
  <div class="modal-card">
    <h2 data-i18n="accuse.title">Formal Accusation</h2>
    <p data-i18n="accuse.description">This is irreversible. Select the person you believe committed the murder and present your case. Choose carefully — an incorrect accusation will damage your investigation.</p>
    <div class="suspect-grid" id="suspect-grid"></div>
    <div class="modal-actions">
      <button id="cancel-accuse" data-i18n="accuse.cancel">Cancel</button>
      <button id="confirm-accuse" disabled data-i18n="accuse.confirm">Confirm Accusation</button>
    </div>
  </div>
</div>

<!-- ════════ Case Ready Modal (Endgame Trigger) ════════ -->
<div id="case-ready-modal">
  <div class="modal-card case-ready-card">
    <h2 data-i18n="endgame.title">All Critical Evidence Gathered</h2>
    <p data-i18n="endgame.description">You have gathered all the key evidence needed to build a case. Review your evidence, make an accusation, or continue investigating for additional details.</p>
    <div class="case-ready-actions">
      <button id="case-ready-review" data-i18n="endgame.review">Review Evidence</button>
      <button id="case-ready-accuse" data-i18n="endgame.accuse">Make Accusation</button>
      <button id="case-ready-continue" data-i18n="endgame.continue">Keep Investigating</button>
    </div>
  </div>
</div>

<!-- ════════ Outcome Screen ════════ -->
<div id="outcome-screen">
  <div class="outcome-card" id="outcome-card">
    <h2 id="outcome-title"></h2>
    <div class="outcome-text" id="outcome-text"></div>
    <button id="restart-btn" data-i18n="outcome.restart">New Investigation</button>
  </div>
</div>

<!-- ════════ Keycard Logs Terminal Modal ════════ -->
<div id="keycard-modal">
  <div class="keycard-terminal">
    <div class="keycard-terminal-bar">
      <span class="keycard-terminal-title" data-i18n="keycard.title">■ LYRIC ATRIUM HOTEL — KEYCARD ACCESS CONTROL</span>
      <button class="keycard-terminal-close" id="keycard-modal-close">✕</button>
    </div>
    <div class="keycard-terminal-info" data-i18n="keycard.subtitle">EVENT LOG — 2024-11-15 — GALA NIGHT — ALL ZONES</div>
    <div class="keycard-terminal-body" id="keycard-terminal-body"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script src="i18n.js?v=13"></script>
<script>
/* ================================================================
   ECHOES IN THE ATRIUM — Game Frontend
   ================================================================ */
(() => {
  "use strict";

  // Create toast container dynamically (avoids HTML parser issues)
  const _toastContainer = document.createElement("div");
  _toastContainer.id = "discovery-toast-container";
  document.body.appendChild(_toastContainer);

  const API_BASE = window.location.origin;
  const CULPRIT_ID = "noah-sterling";

  /* ══════════════════════════════════════════════════════════════
     AUTH & CLOUD SAVE MODULE
     ══════════════════════════════════════════════════════════════ */
  const AUTH_STORAGE_KEY = "echoes_auth";
  const SUPABASE_URL = "https://hnfrnqizlahwxlootoho.supabase.co";

  // Auth state
  let authUser = null;          // { user_id, email, access_token, refresh_token }
  let cloudSaveTimer = null;
  let cloudSavePending = false;
  let _cloudMergePromise = null; // set during boot so init() can await it
  let supabaseConfigured = false;

  // ── Persist auth tokens in localStorage ───────────────────────
  function saveAuthTokens(data) {
    try {
      localStorage.setItem(AUTH_STORAGE_KEY, JSON.stringify({
        user_id: data.user_id,
        email: data.email,
        access_token: data.access_token,
        refresh_token: data.refresh_token,
      }));
    } catch {}
  }

  function loadAuthTokens() {
    try {
      const raw = localStorage.getItem(AUTH_STORAGE_KEY);
      if (!raw) return null;
      return JSON.parse(raw);
    } catch { return null; }
  }

  function clearAuthTokens() {
    localStorage.removeItem(AUTH_STORAGE_KEY);
  }

  // ── Auth API calls ────────────────────────────────────────────
  async function authSignup(email, password) {
    const res = await fetch(`${API_BASE}/api/auth/signup`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, password }),
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.detail || "Signup failed");
    return data;
  }

  async function authLogin(email, password) {
    const res = await fetch(`${API_BASE}/api/auth/login`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, password }),
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.detail || "Login failed");
    return data;
  }

  async function authLogout() {
    if (!authUser?.access_token) return;
    try {
      await fetch(`${API_BASE}/api/auth/logout`, {
        method: "POST",
        headers: { Authorization: `Bearer ${authUser.access_token}` },
      });
    } catch {}
  }

  async function authCheckSession(token) {
    const res = await fetch(`${API_BASE}/api/auth/session`, {
      headers: { Authorization: `Bearer ${token}` },
    });
    if (!res.ok) throw new Error("Session expired");
    return await res.json();
  }

  async function authRefreshToken(refreshToken) {
    const res = await fetch(`${API_BASE}/api/auth/refresh`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ refresh_token: refreshToken }),
    });
    if (!res.ok) throw new Error("Refresh failed");
    return await res.json();
  }

  // ── Mid-session token refresh ────────────────────────────────
  /** Try to refresh the access token. Returns true if successful. */
  async function tryRefreshAccessToken() {
    if (!authUser?.refresh_token) return false;
    try {
      const refreshed = await authRefreshToken(authUser.refresh_token);
      authUser = refreshed;
      saveAuthTokens(refreshed);
      return true;
    } catch {
      return false;
    }
  }

  // ── Cloud state API calls ─────────────────────────────────────
  async function cloudSaveState(stateObj) {
    if (!authUser?.access_token) return;
    let res = await fetch(`${API_BASE}/api/state/save`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${authUser.access_token}`,
      },
      body: JSON.stringify({ state: stateObj }),
    });
    // Retry once with refreshed token on 401
    if (res.status === 401 && await tryRefreshAccessToken()) {
      res = await fetch(`${API_BASE}/api/state/save`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${authUser.access_token}`,
        },
        body: JSON.stringify({ state: stateObj }),
      });
    }
    if (!res.ok) {
      const data = await res.json().catch(() => ({}));
      throw new Error(data.detail || `Save failed: HTTP ${res.status}`);
    }
    return await res.json();
  }

  async function cloudLoadState() {
    if (!authUser?.access_token) return null;
    let res = await fetch(`${API_BASE}/api/state/load`, {
      headers: { Authorization: `Bearer ${authUser.access_token}` },
    });
    // Retry once with refreshed token on 401
    if (res.status === 401 && await tryRefreshAccessToken()) {
      res = await fetch(`${API_BASE}/api/state/load`, {
        headers: { Authorization: `Bearer ${authUser.access_token}` },
      });
    }
    if (!res.ok) {
      const data = await res.json().catch(() => ({}));
      throw new Error(data.detail || `Load failed: HTTP ${res.status}`);
    }
    return await res.json();
  }

  async function cloudDeleteState() {
    if (!authUser?.access_token) return;
    let res = await fetch(`${API_BASE}/api/state/delete`, {
      method: "DELETE",
      headers: { Authorization: `Bearer ${authUser.access_token}` },
    });
    // Retry once with refreshed token on 401
    if (res.status === 401 && await tryRefreshAccessToken()) {
      await fetch(`${API_BASE}/api/state/delete`, {
        method: "DELETE",
        headers: { Authorization: `Bearer ${authUser.access_token}` },
      });
    }
  }

  /** Fire-and-forget cloud save using sendBeacon (survives page close). */
  function cloudSaveBeacon() {
    if (!authUser?.access_token || !cloudSavePending) return;
    try {
      const payload = JSON.stringify({ state: buildStateObject() });
      const blob = new Blob([payload], { type: "application/json" });
      // sendBeacon can't set Authorization header, so pass token as query param
      const url = `${API_BASE}/api/state/save?token=${encodeURIComponent(authUser.access_token)}`;
      if (navigator.sendBeacon(url, blob)) {
        cloudSavePending = false;
      }
    } catch (err) {
      console.error("[cloud-save-beacon] Failed:", err);
    }
  }

  // ── Check if Supabase is configured on the server ─────────────
  async function checkSupabaseStatus() {
    try {
      const res = await fetch(`${API_BASE}/api/auth/status`);
      const data = await res.json();
      supabaseConfigured = data.supabase_configured === true;
    } catch {
      supabaseConfigured = false;
    }
    return supabaseConfigured;
  }

  // ── Debounced cloud save (auto-save after changes) ────────────
  let cloudSaveRetries = 0;
  const MAX_CLOUD_RETRIES = 3;

  function scheduleCloudSave() {
    if (!authUser) return;
    cloudSavePending = true;
    cloudSaveRetries = 0; // fresh user action resets retry count
    if (cloudSaveTimer) clearTimeout(cloudSaveTimer);
    cloudSaveTimer = setTimeout(() => flushCloudSave(), 3000);
  }

  async function flushCloudSave() {
    if (!authUser || !cloudSavePending) return;
    const indicator = document.getElementById("cloud-save-indicator");
    try {
      if (indicator) {
        indicator.textContent = "Saving to cloud...";
        indicator.className = "cloud-save-indicator saving";
      }
      const stateObj = buildStateObject();
      await cloudSaveState(stateObj);
      // Clear pending flag AFTER success (not before try)
      cloudSavePending = false;
      cloudSaveRetries = 0;
      if (indicator) {
        indicator.textContent = "Saved to cloud";
        indicator.className = "cloud-save-indicator saved";
        setTimeout(() => { indicator.textContent = ""; }, 2000);
      }
    } catch (err) {
      console.error("[cloud-save] Failed:", err);
      // cloudSavePending stays true — schedule retry with backoff
      cloudSaveRetries++;
      if (cloudSaveRetries <= MAX_CLOUD_RETRIES) {
        const backoff = Math.min(1000 * Math.pow(2, cloudSaveRetries), 15000);
        if (indicator) {
          indicator.textContent = "Cloud save failed — retrying...";
          indicator.className = "cloud-save-indicator error";
        }
        cloudSaveTimer = setTimeout(() => flushCloudSave(), backoff);
      } else {
        console.error("[cloud-save] Giving up after", MAX_CLOUD_RETRIES, "retries");
        cloudSavePending = false;
        cloudSaveRetries = 0;
        if (indicator) {
          indicator.textContent = "Cloud save failed";
          indicator.className = "cloud-save-indicator error";
        }
      }
    }
  }

  // ── Session restore on page load ──────────────────────────────
  async function restoreAuthSession() {
    const stored = loadAuthTokens();
    if (!stored || !stored.access_token) return false;

    try {
      // Validate the token is still good
      const session = await authCheckSession(stored.access_token);
      authUser = stored;
      updateAuthUI();
      return true;
    } catch {
      // Try refreshing the token
      if (stored.refresh_token) {
        try {
          const refreshed = await authRefreshToken(stored.refresh_token);
          authUser = refreshed;
          saveAuthTokens(refreshed);
          updateAuthUI();
          return true;
        } catch {
          clearAuthTokens();
          return false;
        }
      }
      clearAuthTokens();
      return false;
    }
  }

  // ── Auth UI Management ────────────────────────────────────────
  function updateAuthUI() {
    const formsDiv = document.getElementById("auth-forms");
    const loggedInDiv = document.getElementById("auth-logged-in");
    const emailSpan = document.getElementById("auth-user-email");
    const modalTitle = document.getElementById("auth-modal-title");
    const accountBtn = document.getElementById("settings-account-btn");
    const accountLabel = document.getElementById("settings-account-label");

    const logoutRow = document.getElementById("settings-logout-row");

    if (authUser) {
      formsDiv.style.display = "none";
      loggedInDiv.style.display = "";
      emailSpan.textContent = authUser.email;
      modalTitle.textContent = "Account";
      if (accountLabel) accountLabel.textContent = authUser.email;
      if (logoutRow) logoutRow.style.display = "";
    } else {
      formsDiv.style.display = "";
      loggedInDiv.style.display = "none";
      modalTitle.textContent = "Sign In";
      if (accountLabel) accountLabel.textContent = "Sign In / Create Account";
      if (logoutRow) logoutRow.style.display = "none";
    }
  }

  function openAuthModal() {
    document.getElementById("auth-error").textContent = "";
    document.getElementById("auth-info").textContent = "";
    document.getElementById("auth-modal").classList.add("visible");
    updateAuthUI();
  }

  function closeAuthModal() {
    document.getElementById("auth-modal").classList.remove("visible");
    window.__authFromTitleCard = false;
  }

  // ── Wire up auth UI events (called once at boot) ──────────────
  function initAuthUI() {
    const modal = document.getElementById("auth-modal");
    const closeBtn = document.getElementById("auth-close");
    const submitBtn = document.getElementById("auth-submit");
    const logoutBtn = document.getElementById("auth-logout");
    const emailInput = document.getElementById("auth-email");
    const passInput = document.getElementById("auth-password");
    const errorEl = document.getElementById("auth-error");
    const infoEl = document.getElementById("auth-info");
    const tabBtns = document.querySelectorAll("[data-auth-tab]");
    const accountBtn = document.getElementById("settings-account-btn");

    let currentTab = "login";

    // Tab switching
    tabBtns.forEach(btn => {
      btn.addEventListener("click", () => {
        currentTab = btn.dataset.authTab;
        tabBtns.forEach(b => b.classList.toggle("active", b.dataset.authTab === currentTab));
        submitBtn.textContent = currentTab === "login" ? "Sign In" : "Create Account";
        passInput.placeholder = currentTab === "signup" ? "Min. 6 characters" : "Password";
        passInput.autocomplete = currentTab === "signup" ? "new-password" : "current-password";
        errorEl.textContent = "";
        infoEl.textContent = "";
      });
    });

    // Submit
    submitBtn.addEventListener("click", async () => {
      // Read active tab from DOM (in case it was changed externally, e.g. title card flow)
      const activeTabBtn = document.querySelector("[data-auth-tab].active");
      if (activeTabBtn) currentTab = activeTabBtn.dataset.authTab;

      const email = emailInput.value.trim();
      const password = passInput.value;
      errorEl.textContent = "";
      infoEl.textContent = "";

      if (!email || !password) {
        errorEl.textContent = "Please enter email and password.";
        return;
      }
      if (currentTab === "signup" && password.length < 6) {
        errorEl.textContent = "Password must be at least 6 characters.";
        return;
      }

      submitBtn.disabled = true;
      submitBtn.textContent = currentTab === "login" ? "Signing in..." : "Creating account...";

      try {
        let result;
        if (currentTab === "signup") {
          result = await authSignup(email, password);
          if (!result.access_token) {
            // Email confirmation required
            infoEl.textContent = "Check your email to confirm your account, then sign in.";
            submitBtn.disabled = false;
            submitBtn.textContent = "Create Account";
            return;
          }
        } else {
          result = await authLogin(email, password);
        }

        authUser = result;
        saveAuthTokens(result);
        updateAuthUI();

        // After login, try loading cloud state
        await mergeCloudState();
        renderNpcGrid();
        renderEvidence();

        // If login came from auth prompt, close modal and enter the game
        if (window.__authFromTitleCard) {
          window.__authFromTitleCard = false;
          closeAuthModal();
          const authPrompt = document.getElementById("auth-prompt");
          authPrompt.classList.add("hidden");
          showHubOnCaseboard();
          if (!isTutorialDone()) {
            chatTutorialPending = true;
            setTimeout(() => startTutorial("hub"), 500);
          }
        }

      } catch (err) {
        errorEl.textContent = err.message;
      }
      submitBtn.disabled = false;
      submitBtn.textContent = currentTab === "login" ? "Sign In" : "Create Account";
    });

    // Enter key submits
    [emailInput, passInput].forEach(input => {
      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter") submitBtn.click();
      });
    });

    // Logout
    logoutBtn.addEventListener("click", async () => {
      await flushCloudSave(); // persist any pending state before clearing auth
      await authLogout();
      authUser = null;
      clearAuthTokens();
      resetLocalState();
      updateAuthUI();
      closeAuthModal();
      // Return to title card
      chatScreen.classList.remove("active");
      hubScreen.classList.remove("active");
      titleCard.classList.remove("dismissed", "hidden");
    });

    // Close
    closeBtn.addEventListener("click", closeAuthModal);
    modal.addEventListener("click", (e) => {
      if (e.target === modal) closeAuthModal();
    });

    // Settings account button
    if (accountBtn) {
      accountBtn.addEventListener("click", () => {
        // Close settings first if it's open
        const settingsModal = document.getElementById("settings-modal");
        if (settingsModal) settingsModal.classList.remove("visible");
        openAuthModal();
      });
    }

    // Settings logout button — sign out and return to title card
    const settingsLogoutBtn = document.getElementById("settings-logout-btn");
    if (settingsLogoutBtn) {
      settingsLogoutBtn.addEventListener("click", async () => {
        await flushCloudSave(); // persist any pending state before clearing auth
        // Leave chat BEFORE resetting state so saveState() saves the real state
        if (chatScreen.classList.contains("active")) {
          leaveChat();
        }
        await authLogout();
        authUser = null;
        clearAuthTokens();
        resetLocalState();
        updateAuthUI();
        // Close settings
        const settingsModal = document.getElementById("settings-modal");
        if (settingsModal) settingsModal.classList.remove("visible");
        // Return to title card
        chatScreen.classList.remove("active");
        hubScreen.classList.remove("active");
        titleCard.classList.remove("dismissed", "hidden");
      });
    }
  }

  // ── Merge cloud state with local state ────────────────────────
  async function mergeCloudState() {
    if (!authUser) return;
    try {
      const cloudData = await cloudLoadState();
      if (!cloudData || !cloudData.state) {
        // No cloud save — push local state up (first login / new account)
        await cloudSaveState(buildStateObject());
        return;
      }

      const cloudState = cloudData.state;
      const cloudRichness = stateRichness(cloudState);

      // Read the PERSISTED localStorage state rather than calling buildStateObject(),
      // which always stamps savedAt with the current time (making local always "newer").
      let persistedLocal = null;
      try {
        const raw = localStorage.getItem("echoes_state_v2");
        if (raw) persistedLocal = JSON.parse(raw);
      } catch {}

      // Detect a fresh device by checking for real user-generated content
      // (conversations), NOT total richness — seedStartingEvidence() adds 3
      // evidence items on every fresh page load, inflating richness even when
      // the user has never actually played on this device.
      const localConvCount = persistedLocal?.conversations
        ? Object.values(persistedLocal.conversations)
            .reduce((n, msgs) => n + (Array.isArray(msgs) ? msgs.length : 0), 0)
        : 0;

      if (localConvCount === 0 && cloudRichness > 0) {
        // Fresh device / cleared local — cloud is clearly better
        console.log("[cloud-merge] Fresh device — using cloud state (%d items)", cloudRichness);
        applyStateObject(cloudState);
        saveState(); // persist to localStorage so local matches cloud
        return;
      }

      // Both sides have real user data — compare using persisted timestamps
      const cloudTime = cloudData.updated_at ? new Date(cloudData.updated_at).getTime() : 0;
      const localTime = persistedLocal?.savedAt ? new Date(persistedLocal.savedAt).getTime() : 0;
      const localRichness = stateRichness(persistedLocal);

      let useCloud;
      if (cloudRichness === 0 && localRichness > 0) {
        // Cloud is empty but local has data — keep local
        useCloud = false;
      } else if (cloudTime && localTime) {
        // Both have timestamps — newer wins, but within 5s use richness as tiebreaker
        const drift = Math.abs(cloudTime - localTime);
        if (drift < 5000) {
          useCloud = cloudRichness > localRichness;
        } else {
          useCloud = cloudTime > localTime;
        }
      } else {
        // Missing timestamp(s) — fall back to richness
        useCloud = cloudRichness >= localRichness;
      }

      if (useCloud) {
        console.log("[cloud-merge] Using cloud state (cloud=%d, local=%d items)",
                    cloudRichness, localRichness);
        applyStateObject(cloudState);
        saveState(); // persist to localStorage so local matches cloud
      } else {
        console.log("[cloud-merge] Keeping local state (local=%d, cloud=%d items)",
                    localRichness, cloudRichness);
        await cloudSaveState(buildStateObject());
      }
    } catch (err) {
      console.error("[cloud-load] Failed to merge cloud state:", err);
    }
  }

  /* ══════════════════════════════════════════════════════════════
     END AUTH MODULE
     ══════════════════════════════════════════════════════════════ */

  /* ── NPC metadata (initials & order; roles come from i18n) ── */
  const NPC_META = {
    "lila-chen":     { initials: "LC", order: 0 },
    "amelia-reyes":  { initials: "AR", order: 1 },
    "noah-sterling": { initials: "NS", order: 2 },
    "celeste-ward":  { initials: "CW", order: 3 },
    "gideon-holt":   { initials: "GH", order: 4 },
    "mira-kline":    { initials: "MK", order: 5 },
    "eddie-voss":    { initials: "EV", order: 6 },
    "priya-shah":    { initials: "PS", order: 7 },
    "marcus-vale":   { initials: "MV", order: 8 },
  };

  const VALID_EXPRESSIONS = ["neutral", "guarded", "distressed", "angry", "contemplative", "smirking"];
  let currentExpression = {};  // npcId → last known expression

  function portraitUrl(npcId, expression = "neutral") {
    return `portraits/${npcId}/${expression}.webp`;
  }

  /** Build an <img> element for a portrait, falling back to initials on error. */
  function buildPortraitImg(npcId, expression = "neutral", size = 36) {
    const meta = NPC_META[npcId] || { initials: "?" };
    const img = new Image(size, size);
    img.src = portraitUrl(npcId, expression);
    img.alt = meta.initials;
    img.loading = "lazy";
    img.onerror = function() {
      this.parentElement.textContent = meta.initials;
    };
    return img;
  }

  /** Update the chat portrait to the given expression. */
  function setHeaderExpression(npcId, expression) {
    if (!VALID_EXPRESSIONS.includes(expression)) expression = "neutral";
    currentExpression[npcId] = expression;
    if (npcId === activeNpcId && chatPortraitImg) {
      chatPortraitImg.src = portraitUrl(npcId, expression);
    }
  }

  function npcRole(npcId) {
    return t("role." + npcId);
  }

  /** Update the interrogation icon gauges for the active NPC. */
  function updateInterrogationUI(npcId) {
    const gaugesContainer = document.getElementById("interrogation-gauges");
    const gaugeP = document.getElementById("gauge-pressure");
    const gaugeR = document.getElementById("gauge-rapport");
    const iconP  = document.getElementById("gauge-pressure-icon");
    const iconR  = document.getElementById("gauge-rapport-icon");
    if (!gaugeP || !gaugeR) return;

    // Lila: hide gauges, show hint button; suspects: show gauges, hide hint
    const hintBtn = document.getElementById("lila-hint-btn");
    if (npcId === "lila-chen") {
      gaugeP.style.display = "none";
      gaugeR.style.display = "none";
      if (hintBtn) hintBtn.classList.add("visible");
      return;
    }
    if (hintBtn) hintBtn.classList.remove("visible");
    gaugeP.style.display = "";
    gaugeR.style.display = "";

    const state = npcInterrogation[npcId] || { pressure_band: "calm", rapport_band: "neutral" };

    // Update wrapper classes for glow styling
    gaugeP.className = "gauge gauge-pressure " + state.pressure_band;
    gaugeR.className = "gauge gauge-rapport " + state.rapport_band;

    // Swap icon images with pulse animation on change
    const newPSrc = "icons/pressure-" + state.pressure_band + ".png";
    const newRSrc = "icons/rapport-" + state.rapport_band + ".png";
    if (!iconP.src.endsWith(newPSrc)) {
      iconP.src = newPSrc;
      iconP.classList.add("pulse");
      setTimeout(() => iconP.classList.remove("pulse"), 600);
    }
    if (!iconR.src.endsWith(newRSrc)) {
      iconR.src = newRSrc;
      iconR.classList.add("pulse");
      setTimeout(() => iconR.classList.remove("pulse"), 600);
    }
  }

  /** Check if all canonical evidence is collected and trigger endgame. */
  function checkEndgameTrigger() {
    if (caseReadyPromptShown) return;
    const collectedIds = evidence.map(e => e.id);
    if (!CANONICAL_EVIDENCE.every(id => collectedIds.includes(id))) return;
    caseReadyPromptShown = true;
    saveState();
    document.getElementById("case-ready-modal").classList.add("visible");
  }

  /* ── State ──────────────────────────────────────────────── */
  let npcs = [];
  let activeNpcId = null;
  let conversations = {};
  let evidence = [];
  let discoveries = {};
  let npcInterrogation = {};   // npc_id → { pressure, rapport, pressure_band, rapport_band }
  let caseReadyPromptShown = false;
  let sending = false;
  let accusationTarget = null;

  /* ── Gameplay tracking ─────────────────────────────────── */
  let gameId = localStorage.getItem("echoes_game_id") || crypto.randomUUID();
  localStorage.setItem("echoes_game_id", gameId);

  function trackEvent(endpoint, payload) {
    fetch(`${API_BASE}/api/track/${endpoint}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    }).catch(() => {});  // fire-and-forget
  }

  /* ── Canonical evidence for endgame trigger ────────── */
  const CANONICAL_EVIDENCE = [
    "oil-trace", "burned-notebook", "keycard-logs", "key-trail",
    "oil-cufflinks", "financial-misconduct", "encrypted-schedule", "surveillance",
  ];

  /* ── Voice State ─────────────────────────────────── */
  let audioEnabled = localStorage.getItem("echoes_audio") !== "false";
  let mediaRecorder = null;
  let audioChunks = [];
  let isRecording = false;
  let isTranscribing = false;
  let audioCache = new Map();
  let currentAudio = null;
  let npcVoices = {};
  let voiceMode = false;
  let chatAbortController = null;
  let ttsAbortController = null;
  let silenceTimer = null;
  let audioContext = null;
  let analyserNode = null;
  let silenceCheckRAF = null;

  /* ── DOM refs ───────────────────────────────────────────── */
  const $ = (s) => document.querySelector(s);

  // Screens
  const titleCard         = $("#title-card");
  const titleCardBtn      = $("#title-card-btn");
  const hubScreen         = $("#hub-screen");
  const chatScreen        = $("#chat-screen");
  const TITLE_STORAGE_KEY = "echoes_title_seen";

  // Hub elements
  const npcGridEl         = $("#npc-grid");
  const hubSettingsTab    = $("#hub-settings-tab");

  // Chat elements
  const navToSuspects     = $("#nav-to-suspects");
  const navToCaseboard    = $("#nav-to-caseboard");
  const chatPortraitImg   = $("#chat-portrait-img");
  const portraitName      = $("#portrait-name");
  const portraitRole      = $("#portrait-role");
  const portraitStatus    = $("#portrait-status");
  const chatMessages      = $("#chat-messages");
  const typingIndicator   = $("#typing-indicator");
  const chatInputBar      = $("#chat-input-bar");
  const chatInput         = $("#chat-input");
  const sendBtn           = $("#send-btn");
  const cancelBtn         = $("#cancel-btn");
  const micBtn            = $("#mic-btn");
  const audioToggle       = $("#audio-toggle");

  // Chat dossier

  // Case Board (hub)
  const cbEvidenceList    = $("#cb-evidence-list");
  const cbEvidenceEmpty   = $("#cb-evidence-empty");

  // Modals
  const accusationModal   = $("#accusation-modal");
  const suspectGrid       = $("#suspect-grid");
  const cancelAccuse      = $("#cancel-accuse");
  const confirmAccuse     = $("#confirm-accuse");
  const outcomeScreen     = $("#outcome-screen");
  const outcomeCard       = $("#outcome-card");
  const outcomeTitle      = $("#outcome-title");
  const outcomeText       = $("#outcome-text");
  const restartBtn        = $("#restart-btn");

  /* ── Helpers ────────────────────────────────────────────── */

  /** Count total conversation messages + evidence items as a state richness proxy. */
  function stateRichness(s) {
    if (!s) return 0;
    let count = 0;
    if (s.conversations) {
      for (const msgs of Object.values(s.conversations)) {
        count += Array.isArray(msgs) ? msgs.length : 0;
      }
    }
    if (Array.isArray(s.evidence)) count += s.evidence.length;
    return count;
  }

  /** Build a plain object from current game state (used for both localStorage and cloud). */
  function buildStateObject() {
    return {
      conversations,
      evidence,
      activeNpcId,
      discoveries,
      npcInterrogation,
      caseReadyPromptShown,
      briefingOpen,
      // Also persist tutorial / UI flags for full cloud restore
      tutorialDone: localStorage.getItem(TUTORIAL_STORAGE_KEY) === "true",
      titleSeen: !!localStorage.getItem(TITLE_STORAGE_KEY),
      lilaHintSeen: !!localStorage.getItem(LILA_HINT_STORAGE_KEY),
      audioEnabled,
      language: window.currentLang || "en",
      gameId,
      savedAt: new Date().toISOString(),
    };
  }

  /** Apply a state object (from cloud or localStorage) to the running game variables. */
  function applyStateObject(s) {
    if (!s) return;
    if (s.conversations) conversations = s.conversations;
    if (s.evidence) evidence = s.evidence;
    if ("activeNpcId" in s) activeNpcId = s.activeNpcId; // may be null (on hub)
    if (s.discoveries) discoveries = s.discoveries;
    if (s.npcInterrogation) npcInterrogation = s.npcInterrogation;
    if (s.caseReadyPromptShown !== undefined) caseReadyPromptShown = s.caseReadyPromptShown;
    if (s.briefingOpen !== undefined) briefingOpen = s.briefingOpen;
    // Restore tutorial flags
    if (s.tutorialDone) localStorage.setItem(TUTORIAL_STORAGE_KEY, "true");
    if (s.titleSeen) localStorage.setItem(TITLE_STORAGE_KEY, "1");
    if (s.lilaHintSeen) localStorage.setItem(LILA_HINT_STORAGE_KEY, "1");
    if (s.language && typeof switchLanguage === "function") {
      window.currentLang = s.language;
    }
    if (s.gameId) { gameId = s.gameId; localStorage.setItem("echoes_game_id", gameId); }
    if (s.audioEnabled !== undefined) {
      audioEnabled = s.audioEnabled;
      localStorage.setItem("echoes_audio", String(audioEnabled));
    }
  }

  function saveState() {
    // Always save to localStorage (offline-first) — use buildStateObject for consistency
    try {
      localStorage.setItem("echoes_state_v2", JSON.stringify(buildStateObject()));
    } catch {}
    // Schedule a debounced cloud save if logged in
    scheduleCloudSave();
  }

  function loadState() {
    try {
      const raw = localStorage.getItem("echoes_state_v2");
      if (!raw) return;
      const s = JSON.parse(raw);
      if (s.conversations) conversations = s.conversations;
      if (s.evidence) evidence = s.evidence;
      if ("activeNpcId" in s) activeNpcId = s.activeNpcId; // may be null (on hub)
      if (s.discoveries) discoveries = s.discoveries;
      if (s.npcInterrogation) npcInterrogation = s.npcInterrogation;
      if (s.caseReadyPromptShown !== undefined) caseReadyPromptShown = s.caseReadyPromptShown;
      if (s.briefingOpen !== undefined) briefingOpen = s.briefingOpen;
      if (s.gameId) { gameId = s.gameId; localStorage.setItem("echoes_game_id", gameId); }
    } catch {}
  }

  /** Wipe all local game state (memory + localStorage). Does NOT touch cloud. */
  function resetLocalState() {
    if (voiceMode) exitVoiceMode();
    conversations = {};
    evidence = [];
    discoveries = {};
    npcInterrogation = {};
    caseReadyPromptShown = false;
    briefingOpen = true;
    activeNpcId = null;
    gameId = crypto.randomUUID();
    if (currentAudio) { currentAudio.pause(); currentAudio = null; }
    for (const url of audioCache.values()) URL.revokeObjectURL(url);
    audioCache.clear();
    localStorage.removeItem("echoes_state_v2");
    localStorage.removeItem("echoes_game_id");
    localStorage.removeItem("echoes_tutorial_done");
    localStorage.removeItem("echoes_title_seen");
    localStorage.removeItem("echoes_lila_hint_seen");
    // Keep echoes_audio (device preference)
  }

  /** Full restart: wipe local state, delete cloud save, start new game session. */
  async function clearState() {
    resetLocalState();
    localStorage.setItem("echoes_game_id", gameId);
    trackEvent("session", { session_id: gameId, language: window.currentLang || "en" });
    if (authUser) {
      try { await cloudDeleteState(); }
      catch (err) { console.error("[cloud] Failed to delete:", err); }
    }
  }

  function escapeHtml(str) {
    const d = document.createElement("div");
    d.textContent = str;
    return d.innerHTML;
  }

  /* ── Screen Transitions ────────────────────────────────── */
  function showHub() {
    chatScreen.classList.remove("active");
    hubScreen.classList.add("active");
    renderNpcGrid();
    renderEvidence();
  }

  function showChat() {
    hubScreen.classList.remove("active");
    chatScreen.classList.add("active");
  }

  /* ── Initialize ─────────────────────────────────────────── */
  const STARTING_EVIDENCE = [
    { id: "oil-trace",       textKey: "evidence.crime_scene" },
    { id: "burned-notebook",  textKey: "evidence.crime_scene" },
    { id: "keycard-logs",     textKey: "evidence.security_systems" },
  ];

  function seedStartingEvidence() {
    let added = false;
    for (const se of STARTING_EVIDENCE) {
      const existing = evidence.find(e => e.id === se.id);
      if (existing) {
        // Migration: ensure textKey is set on older saved evidence
        if (!existing.textKey) existing.textKey = se.textKey;
        continue;
      }
      const meta = EVIDENCE_CATALOG[se.id];
      if (!meta) continue;
      evidence.unshift({
        id: se.id,
        label: t("evidence." + se.id + "_label") || meta.label,
        text: t(se.textKey),
        textKey: se.textKey,
        source: "crime-scene",
      });
      added = true;
    }
    if (added) saveState();
  }

  let briefingOpen = true; // default: open on first visit

  async function init() {
    loadState();
    seedStartingEvidence();
    // Wait for cloud merge to finish (if any) before first render
    // so we always render with the latest cloud state
    if (_cloudMergePromise) {
      await _cloudMergePromise.catch(() => {});
    }
    // Check isNewGame AFTER cloud merge — a returning user on a new device
    // will have no localStorage but WILL have a cloud save, so this avoids
    // a false-positive "new game" analytics event.
    const isNewGame = !conversations || Object.keys(conversations).length === 0;
    if (isNewGame) {
      trackEvent("session", { session_id: gameId, language: window.currentLang || "en" });
    }
    try {
      const res = await fetch(`${API_BASE}/api/npcs`);
      const data = await res.json();
      npcs = data.npcs.sort((a, b) => {
        const oa = NPC_META[a.npc_id]?.order ?? 99;
        const ob = NPC_META[b.npc_id]?.order ?? 99;
        return oa - ob;
      });
      for (const npc of npcs) {
        if (npc.voice) npcVoices[npc.npc_id] = npc.voice;
      }
    } catch {
      npcs = Object.entries(NPC_META).map(([id, m]) => ({
        npc_id: id,
        display_name: id.split("-").map(w => w[0].toUpperCase() + w.slice(1)).join(" "),
      }));
    }

    renderNpcGrid();
    renderEvidence();

    // Restore briefing open/closed state
    const briefingToggle = $("#cb-briefing-toggle");
    const briefingBody = $("#cb-briefing-body");
    briefingToggle.setAttribute("aria-expanded", String(briefingOpen));
    if (briefingOpen) briefingBody.classList.add("open");
    else briefingBody.classList.remove("open");

    const titleSeen = localStorage.getItem(TITLE_STORAGE_KEY);
    const hasConversations = Object.keys(conversations).length > 0;

    if (activeNpcId) {
      // Returning player with active chat — go directly there
      titleCard.classList.add("hidden");
      selectNpc(activeNpcId);
    } else if (!titleSeen && !hasConversations) {
      // First-time player — show title card, hub stays hidden until dismissed
      titleCard.classList.remove("hidden");
    } else {
      // Returning player — skip title card, show hub
      titleCard.classList.add("hidden");
      showHubOnCaseboard();
    }
  }

  function showHubOnCaseboard() {
    hubScreen.classList.add("active");
    document.querySelectorAll(".manila-tab[data-hub-tab]").forEach(t => t.classList.remove("active"));
    document.querySelectorAll(".hub-panel").forEach(p => p.classList.remove("active"));
    document.querySelector('.manila-tab[data-hub-tab="caseboard"]').classList.add("active");
    document.getElementById("hub-caseboard").classList.add("active");
  }

  /* ── Render NPC Grid (5 + 4 staggered rows) ────────────── */
  function renderNpcGrid() {
    npcGridEl.innerHTML = "";

    const row1 = document.createElement("div");
    row1.className = "npc-row";
    const row2 = document.createElement("div");
    row2.className = "npc-row";

    for (let i = 0; i < npcs.length; i++) {
      const npc = npcs[i];
      const meta = NPC_META[npc.npc_id] || { initials: "?" };
      const card = document.createElement("div");
      card.className = "npc-card";
      if (npc.npc_id === "lila-chen") card.classList.add("npc-card-partner");
      if (conversations[npc.npc_id]?.length) card.classList.add("has-talked");
      card.dataset.npcId = npc.npc_id;

      const portraitDiv = document.createElement("div");
      portraitDiv.className = "npc-card-portrait";
      const img = new Image();
      img.src = portraitUrl(npc.npc_id, "neutral");
      img.alt = npc.display_name.split(" — ")[0];
      img.loading = "lazy";
      img.onerror = function() {
        this.parentElement.innerHTML = `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:2rem;font-weight:700;color:var(--text-faint);">${meta.initials}</div>`;
      };
      portraitDiv.appendChild(img);

      const infoDiv = document.createElement("div");
      infoDiv.className = "npc-card-info";
      infoDiv.innerHTML = `
        <div class="npc-card-name">${escapeHtml(npc.display_name.split(" — ")[0])}</div>
        <div class="npc-card-role">${escapeHtml(npcRole(npc.npc_id))}</div>
      `;

      card.appendChild(portraitDiv);
      card.appendChild(infoDiv);

      // Discovery badge — shows exclamation when this NPC yielded unseen discoveries
      if (npcsWithNewDiscoveries.has(npc.npc_id)) {
        const badge = document.createElement("div");
        badge.className = "npc-card-discovery-badge";
        badge.textContent = "!";
        card.appendChild(badge);
      }

      card.addEventListener("click", () => selectNpc(npc.npc_id));

      // First 5 go to row 1, rest to row 2
      if (i < 5) {
        row1.appendChild(card);
      } else {
        row2.appendChild(card);
      }
    }

    npcGridEl.appendChild(row1);
    if (row2.children.length > 0) {
      npcGridEl.appendChild(row2);
    }

    // Accusation button below the NPC grid
    const accuseSection = document.createElement("div");
    accuseSection.className = "accuse-section";
    accuseSection.innerHTML = `<button id="hub-accuse-btn" data-i18n="sidebar.accuse">${t("sidebar.accuse")}</button>`;
    npcGridEl.appendChild(accuseSection);
    $("#hub-accuse-btn").addEventListener("click", openAccusationModal);
  }

  /* ── Select NPC ─────────────────────────────────────────── */
  function selectNpc(npcId) {
    if (currentAudio) { currentAudio.pause(); currentAudio = null; }
    if (voiceMode) exitVoiceMode();
    activeNpcId = npcId;
    const npc = npcs.find(n => n.npc_id === npcId);
    const displayName = npc?.display_name?.split(" — ")[0] || npcId;

    // Update portrait
    const expr = currentExpression[npcId] || "neutral";
    chatPortraitImg.src = portraitUrl(npcId, expr);
    chatPortraitImg.alt = displayName;

    // Update nameplate and topbar
    portraitName.textContent = displayName;
    portraitRole.textContent = npcRole(npcId);
    portraitStatus.textContent = "";
    // NPC name/role shown in portrait panel only (topbar has nav buttons)

    // Render conversation and interrogation pills
    renderMessages();
    updateInterrogationUI(npcId);

    // Preload all expressions for smooth transitions
    for (const ex of VALID_EXPRESSIONS) {
      const preload = new Image();
      preload.src = portraitUrl(npcId, ex);
    }

    // Transition to chat screen
    showChat();
    chatInput.focus();
    saveState();

    // Trigger chat-phase tutorial if pending
    if (typeof chatTutorialPending !== "undefined" && chatTutorialPending) {
      if (npcId === "lila-chen") {
        // Lila has no gauges/info — show hint btn + input tutorial instead
        // Keep chatTutorialPending alive so gauges/info tutorial fires for suspects
        setTimeout(() => startTutorial("lila_chat"), 600);
      } else {
        chatTutorialPending = false;
        // If Lila's chat already showed the input bar, only show gauges + info
        const lilaAlreadySeen = localStorage.getItem(LILA_HINT_STORAGE_KEY);
        setTimeout(() => startTutorial(lilaAlreadySeen ? "chat_short" : "chat"), 600);
      }
    }
    // Lila hint button tutorial — show once on first Lila chat visit
    else if (npcId === "lila-chen"
             && typeof LILA_HINT_STORAGE_KEY !== "undefined"
             && !localStorage.getItem(LILA_HINT_STORAGE_KEY)) {
      setTimeout(() => startTutorial("lila"), 600);
    }
  }

  /* ── Render Messages ────────────────────────────────────── */
  function renderMessages() {
    chatMessages.innerHTML = "";
    const history = conversations[activeNpcId] || [];

    if (history.length === 0) {
      const hint = document.createElement("div");
      hint.id = "chat-empty-hint";
      hint.style.cssText = "text-align:center; color:var(--text-faint); font-size:0.85rem; padding:2rem; font-style:italic;";
      const npcName = npcs.find(n => n.npc_id === activeNpcId)?.display_name?.split(" — ")[0] || "this person";
      hint.textContent = t("chat.hint", { name: npcName });
      chatMessages.appendChild(hint);

      // Conversation starter buttons
      const startersDiv = document.createElement("div");
      startersDiv.className = "chat-starters";
      for (let n = 1; n <= 3; n++) {
        const key = `starter.${activeNpcId}.${n}`;
        const text = t(key);
        if (text === key) continue;
        const btn = document.createElement("button");
        btn.className = "chat-starter-btn";
        btn.textContent = text;
        btn.addEventListener("click", () => sendMessage(text));
        startersDiv.appendChild(btn);
      }
      if (startersDiv.children.length > 0) {
        chatMessages.appendChild(startersDiv);
      }
    }

    for (let i = 0; i < history.length; i++) {
      appendMessageBubble(history[i].role, history[i].content, i);
    }
    scrollToBottom();
  }

  // Strip system tags (EXPRESSION, EVIDENCE and their Serbian variants) from display text
  function stripSystemTags(text) {
    return text.replace(/\[(?:EXPRESSION|EVIDENCE|IZRAŽAJ|IZRAZAJ|IZRAZ|EVIDENCIJA|DOKAZ):\s*[^\]]*\]/gi, "").trim();
  }

  function appendMessageBubble(role, content, messageIndex) {
    const div = document.createElement("div");
    div.className = `msg ${role}`;
    const senderLabel = role === "user" ? t("chat.sender_you") :
      (npcs.find(n => n.npc_id === activeNpcId)?.display_name?.split(" — ")[0] || "Suspect");

    const displayContent = role === "assistant" ? stripSystemTags(content) : content;
    let senderHtml = senderLabel;

    if (role === "assistant" && activeNpcId && messageIndex !== undefined) {
      const cacheKey = `${activeNpcId}:${messageIndex}`;
      senderHtml += `<button class="msg-audio-btn" data-cache-key="${cacheKey}"
                data-npc-id="${activeNpcId}" data-msg-index="${messageIndex}"
                title="${t('voice.replay_title')}">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
               stroke-linecap="round" stroke-linejoin="round">
            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
            <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>
          </svg>
        </button>`;
    }

    let html = `<div class="msg-sender">${senderHtml}</div>${escapeHtml(displayContent)}`;

    div.innerHTML = html;

    const replayBtn = div.querySelector(".msg-audio-btn");
    if (replayBtn) {
      replayBtn.addEventListener("click", () => {
        const npcId = replayBtn.dataset.npcId;
        const idx = parseInt(replayBtn.dataset.msgIndex, 10);
        const msgContent = (conversations[npcId] || [])[idx]?.content;
        if (msgContent) speakText(msgContent, npcId, replayBtn.dataset.cacheKey);
      });
    }

    chatMessages.appendChild(div);
  }

  function scrollToBottom() {
    requestAnimationFrame(() => {
      chatMessages.scrollTop = chatMessages.scrollHeight;
    });
  }

  /* ── Send Message ───────────────────────────────────────── */
  async function sendMessage(overrideText, displayText) {
    const text = overrideText || chatInput.value.trim();
    if (!text || !activeNpcId || sending) return;
    const shownText = displayText || text; // what appears in the chat bubble

    sending = true;
    sendBtn.disabled = true;
    showCancelBtn();
    chatAbortController = new AbortController();
    if (!overrideText) { chatInput.value = ""; autoResize(); }

    if (!conversations[activeNpcId]) conversations[activeNpcId] = [];

    // Remove empty-state hint and starters
    const hint = document.getElementById("chat-empty-hint");
    if (hint) hint.remove();
    const starters = chatMessages.querySelector(".chat-starters");
    if (starters) starters.remove();

    // Add user bubble (show friendly display text, store API text in history)
    conversations[activeNpcId].push({ role: "user", content: text });
    const userIdx = conversations[activeNpcId].length - 1;
    appendMessageBubble("user", shownText, userIdx);
    scrollToBottom();

    // Show typing indicator
    typingIndicator.classList.add("visible");
    chatMessages.appendChild(typingIndicator);
    scrollToBottom();
    portraitStatus.textContent = t("chat.status_responding");

    try {
      const historyForApi = conversations[activeNpcId].slice(0, -1);
      const res = await fetch(`${API_BASE}/api/chat`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          npc_id: activeNpcId,
          message: text,
          history: historyForApi,
          language: window.currentLang || "en",
          pressure: (npcInterrogation[activeNpcId] || {}).pressure || 0,
          rapport: (npcInterrogation[activeNpcId] || {}).rapport ?? 25,
          peak_pressure: (npcInterrogation[activeNpcId] || {}).peak_pressure ??
                         (npcInterrogation[activeNpcId] || {}).pressure ?? 0,
          player_evidence_ids: evidence.map(e => e.id),
          player_discovery_ids: Object.values(discoveries).flat().map(d => d.id),
          session_id: gameId,
        }),
        signal: chatAbortController?.signal,
      });

      if (!res.ok) {
        let detail;
        try {
          const errBody = await res.json();
          detail = errBody.detail || `HTTP ${res.status}`;
        } catch (_) {
          const text = await res.text().catch(() => "");
          detail = text ? `HTTP ${res.status}: ${text.slice(0, 200)}` : `HTTP ${res.status} (no response body)`;
        }
        console.error(`[chat] Server error: ${res.status}`, detail);
        throw new Error(detail);
      }

      const data = await res.json();
      conversations[activeNpcId].push({ role: "assistant", content: data.reply });

      typingIndicator.classList.remove("visible");
      const assistantIdx = conversations[activeNpcId].length - 1;
      appendMessageBubble("assistant", data.reply, assistantIdx);
      scrollToBottom();

      // Auto-play TTS only in voice mode
      if (voiceMode) {
        const cacheKey = `${activeNpcId}:${assistantIdx}`;
        speakText(data.reply, activeNpcId, cacheKey);
      }

      // Process evidence and discoveries
      detectEvidence(data.evidence_ids || [], activeNpcId);
      detectNewDiscoveries(data.discovery_ids || [], activeNpcId, data.discovery_summaries || {});

      // Update expression
      if (data.expression) {
        setHeaderExpression(activeNpcId, data.expression);
      }

      // Update interrogation state
      if (data.pressure !== undefined) {
        npcInterrogation[activeNpcId] = {
          pressure: data.pressure,
          rapport: data.rapport,
          pressure_band: data.pressure_band || "calm",
          rapport_band: data.rapport_band || "cold",
          peak_pressure: data.peak_pressure ?? data.pressure,
        };
        updateInterrogationUI(activeNpcId);
      }
      checkEndgameTrigger();

    } catch (err) {
      typingIndicator.classList.remove("visible");
      // Silently ignore user-initiated cancellation
      if (err.name === "AbortError") {
        // Remove the pending user message from conversation
        conversations[activeNpcId].pop();
      } else {
        // Distinguish network errors from server errors
        const isNetwork = err instanceof TypeError && err.message.includes("fetch");
        const displayMsg = isNetwork
          ? "Cannot reach server — is it running on port 8000?"
          : err.message;
        console.error("[chat] Request failed:", err);
        const errDiv = document.createElement("div");
        errDiv.style.cssText = "text-align:center; color:var(--danger); font-size:0.82rem; padding:0.5rem;";
        errDiv.textContent = t("chat.error", { message: displayMsg });
        chatMessages.appendChild(errDiv);
        scrollToBottom();
        conversations[activeNpcId].pop();
      }
    }

    chatAbortController = null;
    portraitStatus.textContent = "";
    sending = false;
    sendBtn.disabled = !chatInput.value.trim();
    hideCancelBtn();
    saveState();
  }

  /* ── Evidence Detection ─────────────────────────────────── */
  const EVIDENCE_CATALOG = {
    "oil-trace":            { label: "Antique Oil Trace" },
    "burned-notebook":      { label: "Burned Notebook Fragment" },
    "keycard-logs":         { label: "Keycard Access Logs" },
    "key-trail":            { label: "Maintenance Key Trail" },
    "power-outage":         { label: "Deliberate Power Sabotage" },
    "encrypted-schedule":   { label: "Encrypted Schedule" },
    "financial-misconduct": { label: "Financial Misconduct" },
    "oil-cufflinks":        { label: "Oil on Cufflinks" },
    "surveillance":         { label: "CCTV Footage Gaps" },
    "secret-affair":        { label: "Secret Affair" },
    "audio-recording":      { label: "Audio Recording" },
    "nda-ip":               { label: "NDA / IP Theft" },
    "blackmail":            { label: "Blackmail Evidence" },
    "data-sales":           { label: "Illegal Data Sales" },
    "plagiarism":           { label: "Plagiarized Research" },
    "lockpick-marks":       { label: "Lockpick Marks" },
    "hotel-sale":           { label: "Hotel Sale Plan" },
    "stage-timing":         { label: "Stage Timing Gaps" },
  };

  /* Maps discovery IDs to their parent evidence category.
     Mirrors DISCOVERY_CATALOG on the server. */
  const DISCOVERY_EVIDENCE_MAP = {
    "amelia-key-loan": "key-trail",       "amelia-breaker": "power-outage",
    "amelia-hotel-sale": "hotel-sale",     "amelia-lockpick": "lockpick-marks",
    "noah-embezzlement": "financial-misconduct", "noah-board-vote": "encrypted-schedule",
    "noah-oil-cufflinks": "oil-cufflinks", "noah-key-access": "key-trail",
    "noah-cctv-gap": "surveillance",
    "celeste-affair": "secret-affair",     "celeste-recordings": "audio-recording",
    "celeste-rooftop-witness": "surveillance",
    "gideon-blackmail": "blackmail",       "gideon-data-sales": "data-sales",
    "gideon-notebook": "burned-notebook",  "gideon-saw-noah": "surveillance",
    "mira-plagiarism": "plagiarism",       "mira-meeting": "encrypted-schedule",
    "eddie-key-loan": "key-trail",         "eddie-gave-noah-key": "key-trail",
    "priya-saw-noah": "surveillance",      "priya-holt-argument": "blackmail",
    "priya-mira-tip": "plagiarism",
    "marcus-noah-absence": "stage-timing", "marcus-celeste-break": "stage-timing",
  };

  /**
   * Process new discoveries from the server's discovery-level detection.
   * Each discovery fires independently with an LLM-generated summary.
   */
  function detectNewDiscoveries(discoveryIds, npcId, discoverySummaries) {
    const newTexts = [];

    for (const did of discoveryIds) {
      const evidenceId = DISCOVERY_EVIDENCE_MAP[did];
      if (!evidenceId) continue;
      if (!discoveries[npcId]) discoveries[npcId] = [];
      if (discoveries[npcId].find(d => d.id === did)) continue;

      // Use LLM summary if available; fall back to pre-written i18n text
      const summary = discoverySummaries[did];
      const fallbackKey = "discovery." + did;
      const displayText = summary || t(fallbackKey);

      discoveries[npcId].push({
        id: did,
        text: summary || fallbackKey,  // Store literal summary or i18n key as fallback
        evidenceId: evidenceId,
        timestamp: Date.now(),
        isNew: true,
      });
      newTexts.push(displayText);
      trackEvent("discovery", { session_id: gameId, evidence_id: evidenceId, npc_id: npcId, discovery_id: did });
    }

    if (newTexts.length > 0) {
      for (const txt of newTexts) showDiscoveryToast(txt);
      npcsWithNewDiscoveries.add(npcId);
      markLastAssistantMessage();
      renderEvidence();
      flashCaseBoardTab();
    }
  }

  function markLastAssistantMessage() {
    const msgs = chatMessages.querySelectorAll(".msg.assistant");
    const last = msgs[msgs.length - 1];
    if (!last || last.querySelector(".msg-discovery-icon")) return;
    const icon = document.createElement("span");
    icon.className = "msg-discovery-icon";
    icon.title = t("toast.new_discovery");
    icon.textContent = "!";
    last.appendChild(icon);
    last.classList.add("msg-has-discovery");
  }

  let unseenDiscoveryCount = 0;

  function flashCaseBoardTab() {
    unseenDiscoveryCount++;
    // Flash both the hub caseboard tab and the chat-nav caseboard tab
    const tabs = document.querySelectorAll('.manila-tab[data-hub-tab="caseboard"], #nav-to-caseboard');
    tabs.forEach(tab => {
      tab.classList.add("tab-flash");
      setTimeout(() => tab.classList.remove("tab-flash"), 4000);
      // Add or update badge
      let badge = tab.querySelector(".tab-badge");
      if (!badge) {
        badge = document.createElement("span");
        badge.className = "tab-badge";
        tab.appendChild(badge);
      }
      badge.textContent = unseenDiscoveryCount;
    });
  }

  function clearCaseBoardBadges() {
    unseenDiscoveryCount = 0;
    document.querySelectorAll('.manila-tab .tab-badge').forEach(b => b.remove());
    if (npcsWithNewDiscoveries.size > 0) {
      npcsWithNewDiscoveries.clear();
      renderNpcGrid();
    }
  }

  function showDiscoveryToast(text) {
    const container = document.getElementById("discovery-toast-container");
    const toast = document.createElement("div");
    toast.className = "discovery-toast";
    toast.innerHTML = `
      <div class="discovery-toast-icon">
        <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor"
          stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
        </svg>
      </div>
      <div class="discovery-toast-body">
        <div class="discovery-toast-heading">${escapeHtml(t("toast.new_discovery"))}</div>
        <div class="discovery-toast-text">${escapeHtml(text)}</div>
      </div>`;
    container.appendChild(toast);
    setTimeout(() => {
      toast.classList.add("hiding");
      toast.addEventListener("transitionend", () => toast.remove(), { once: true });
      setTimeout(() => { if (toast.parentNode) toast.remove(); }, 500);
    }, 4500);
  }

  /* ── NPC Discovery Badges ──────────────────────────────── */
  const npcsWithNewDiscoveries = new Set();

  function detectEvidence(evidenceIds, npcId) {
    const npcName = npcs.find(n => n.npc_id === npcId)?.display_name?.split(" — ")[0] || npcId;
    let found = false;

    for (const id of evidenceIds) {
      const meta = EVIDENCE_CATALOG[id];
      if (!meta) continue;

      if (!evidence.find(e => e.id === id)) {
        evidence.push({
          id: id,
          label: t("evidence." + id + "_label") || meta.label,
          text: t(npcId === "lila-chen" ? "evidence.mentioned_by_partner" : "evidence.mentioned_by", { name: npcName }),
          textKey: npcId === "lila-chen" ? "evidence.mentioned_by_partner" : "evidence.mentioned_by",
          source: npcId,
        });
        found = true;
      }
    }

    if (found) {
      renderEvidence();
    }
  }

  /* ── Render Evidence (Case Board) ────────────────────────── */
  const EVIDENCE_GROUPS = {
    physical:    ["oil-trace", "oil-cufflinks", "lockpick-marks"],
    documentary: ["burned-notebook", "encrypted-schedule", "nda-ip"],
    testimony:   ["secret-affair", "audio-recording", "plagiarism", "hotel-sale"],
    access:      ["keycard-logs", "key-trail", "power-outage", "stage-timing"],
    motive:      ["financial-misconduct", "blackmail", "data-sales", "surveillance"],
  };

  /** Find collected discoveries linked to an evidence ID. */
  function getDiscoveriesForEvidence(evidenceId) {
    const results = [];
    for (const [npcId, discs] of Object.entries(discoveries)) {
      for (const d of discs) {
        if (d.evidenceId === evidenceId) {
          results.push({ ...d, npcId });
        }
      }
    }
    return results;
  }

  /** Render a single evidence item with its linked discoveries. */
  function renderEvidenceItem(e) {
    const div = document.createElement("div");
    div.className = "clue-item";
    // Re-translate at render time for current language
    const label = t("evidence." + e.id + "_label") || e.label;
    let text = e.text;
    if (e.textKey) {
      if (e.textKey === "evidence.mentioned_by" || e.textKey === "evidence.mentioned_by_partner") {
        const npcName = npcs.find(n => n.npc_id === e.source)?.display_name?.split(" — ")[0] || e.source;
        const key = e.source === "lila-chen" ? "evidence.mentioned_by_partner" : "evidence.mentioned_by";
        text = t(key, { name: npcName }) || text;
      } else {
        text = t(e.textKey) || text;
      }
    }
    let html = `<div class="clue-label">${escapeHtml(label)}</div>
      <div class="clue-text">${escapeHtml(text)}</div>`;

    const linkedDisc = getDiscoveriesForEvidence(e.id);
    if (linkedDisc.length > 0) {
      html += `<div class="clue-discoveries">`;
      for (const d of linkedDisc) {
        // t() returns the key as-is when not found, so literal summaries pass through
        const displayText = t(d.text);
        html += `<div class="clue-discovery-item">${escapeHtml(displayText)}</div>`;
      }
      html += `</div>`;
    }
    if (e.id === "keycard-logs") {
      html += `<button class="clue-view-logs-btn" onclick="window.__openKeycardModal()">${t("keycard.view_logs")}</button>`;
    }
    div.innerHTML = html;
    return div;
  }

  function renderEvidence() {
    cbEvidenceList.innerHTML = "";
    cbEvidenceEmpty.style.display = evidence.length ? "none" : "block";

    if (caseReadyPromptShown && evidence.length > 0) {
      // Grouped view with section headers
      for (const [groupKey, ids] of Object.entries(EVIDENCE_GROUPS)) {
        const groupEvidence = evidence.filter(e => ids.includes(e.id));
        if (groupEvidence.length === 0) continue;
        const header = document.createElement("div");
        header.className = "evidence-group-header";
        header.textContent = t("evidence.group_" + groupKey);
        cbEvidenceList.appendChild(header);
        for (const e of groupEvidence) cbEvidenceList.appendChild(renderEvidenceItem(e));
      }
      // Accusation CTA
      const cta = document.createElement("button");
      cta.className = "evidence-accuse-cta";
      cta.textContent = t("endgame.accuse_cta");
      cta.addEventListener("click", openAccusationModal);
      cbEvidenceList.appendChild(cta);
    } else {
      for (const e of evidence) cbEvidenceList.appendChild(renderEvidenceItem(e));
    }
  }

  /* ── Auto-resize textarea ───────────────────────────────── */
  function autoResize() {
    chatInput.style.height = "auto";
    chatInput.style.height = Math.min(chatInput.scrollHeight, 120) + "px";
  }

  /* ── Settings Modal ──────────────────────────────────────── */
  const settingsModal     = $("#settings-modal");
  const settingsCloseBtn  = $("#settings-close");
  const settingsRestartBtn   = $("#settings-restart-btn");
  const settingsRestartRow   = $("#settings-restart-row");
  const settingsRestartConfirm = $("#settings-restart-confirm");
  const settingsRestartCancel  = $("#settings-restart-cancel");
  const settingsRestartYes     = $("#settings-restart-yes");

  function openSettings() {
    settingsRestartRow.style.display = "";
    settingsRestartConfirm.style.display = "none";
    settingsModal.classList.add("visible");
  }

  function closeSettings() {
    settingsModal.classList.remove("visible");
  }

  hubSettingsTab.addEventListener("click", openSettings);
  settingsCloseBtn.addEventListener("click", closeSettings);
  settingsModal.addEventListener("click", (e) => {
    if (e.target === settingsModal) closeSettings();
  });

  settingsRestartBtn.addEventListener("click", () => {
    settingsRestartRow.style.display = "none";
    settingsRestartConfirm.style.display = "";
  });

  settingsRestartCancel.addEventListener("click", () => {
    settingsRestartRow.style.display = "";
    settingsRestartConfirm.style.display = "none";
  });

  settingsRestartYes.addEventListener("click", () => {
    closeSettings();
    clearState();
    briefingOpen = true;
    seedStartingEvidence();
    chatScreen.classList.remove("active");
    chatMessages.innerHTML = "";
    renderEvidence();
    renderNpcGrid();
    // Go to hub on Case Board tab with briefing expanded
    hubScreen.classList.add("active");
    document.querySelectorAll(".manila-tab[data-hub-tab]").forEach(t => t.classList.remove("active"));
    document.querySelectorAll(".hub-panel").forEach(p => p.classList.remove("active"));
    document.querySelector('.manila-tab[data-hub-tab="caseboard"]').classList.add("active");
    document.getElementById("hub-caseboard").classList.add("active");
    const briefingToggle = $("#cb-briefing-toggle");
    const briefingBody = $("#cb-briefing-body");
    briefingToggle.setAttribute("aria-expanded", "true");
    briefingBody.classList.add("open");
  });

  /* ── Accusation System ──────────────────────────────────── */
  function openAccusationModal() {
    accusationTarget = null;
    confirmAccuse.disabled = true;
    suspectGrid.innerHTML = "";

    const suspects = npcs.filter(n => n.npc_id !== "lila-chen");
    for (const s of suspects) {
      const btn = document.createElement("div");
      btn.className = "suspect-option";
      const img = buildPortraitImg(s.npc_id, "neutral", 48);
      img.className = "suspect-portrait";
      btn.appendChild(img);
      btn.appendChild(document.createTextNode(s.display_name.split(" — ")[0]));
      btn.dataset.npcId = s.npc_id;
      btn.addEventListener("click", () => {
        document.querySelectorAll(".suspect-option").forEach(el => el.classList.remove("selected"));
        btn.classList.add("selected");
        accusationTarget = s.npc_id;
        confirmAccuse.disabled = false;
      });
      suspectGrid.appendChild(btn);
    }
    accusationModal.classList.add("visible");
  }

  function closeAccusationModal() {
    accusationModal.classList.remove("visible");
    accusationTarget = null;
  }

  function resolveAccusation() {
    if (!accusationTarget) return;
    const target = accusationTarget;
    closeAccusationModal();

    const correct = target === CULPRIT_ID;
    const accusedName = npcs.find(n => n.npc_id === target)?.display_name?.split(" — ")[0] || target;

    outcomeCard.className = "outcome-card " + (correct ? "correct" : "wrong");

    const interviewCount = Object.keys(conversations).filter(k => conversations[k].length > 0).length;
    trackEvent("accusation", {
      session_id: gameId,
      target_npc_id: target,
      correct,
      evidence_count: evidence.length,
      interview_count: interviewCount,
    });
    if (correct) {
      outcomeTitle.textContent = t("outcome.correct_title");
      outcomeText.innerHTML = t("outcome.correct_text", {
        name: escapeHtml(accusedName),
        evidenceCount: evidence.length,
        interviewCount: interviewCount,
      });
    } else {
      outcomeTitle.textContent = t("outcome.wrong_title");
      outcomeText.innerHTML = t("outcome.wrong_text", { name: escapeHtml(accusedName) });
    }
    outcomeScreen.classList.add("visible");
  }

  /* ── Event Listeners ────────────────────────────────────── */
  // Intro screen removed — game starts on Case Board directly

  // Case board briefing toggle (persists state)
  $("#cb-briefing-toggle").addEventListener("click", () => {
    const toggle = $("#cb-briefing-toggle");
    const body = $("#cb-briefing-body");
    const expanded = toggle.getAttribute("aria-expanded") === "true";
    toggle.setAttribute("aria-expanded", String(!expanded));
    body.classList.toggle("open");
    briefingOpen = !expanded;
    saveState();
  });

  /* ── Cancel button: show/hide + abort logic ──────────── */
  function showCancelBtn() {
    chatInputBar.classList.add("cancellable");
  }
  function hideCancelBtn() {
    chatInputBar.classList.remove("cancellable");
  }
  function cancelResponse() {
    // Abort in-flight chat request
    if (chatAbortController) { chatAbortController.abort(); chatAbortController = null; }
    // Abort in-flight TTS request
    if (ttsAbortController) { ttsAbortController.abort(); ttsAbortController = null; }
    // Stop any playing audio
    if (currentAudio) { currentAudio.pause(); currentAudio = null; }
    // Reset UI state
    typingIndicator.classList.remove("visible");
    portraitStatus.textContent = "";
    sending = false;
    sendBtn.disabled = !chatInput.value.trim();
    hideCancelBtn();
    // Exit voice-mode waiting state (don't auto-restart recording)
    if (voiceMode) {
      micBtn.classList.remove("waiting");
      exitVoiceMode();
    }
  }
  cancelBtn.addEventListener("click", cancelResponse);

  function leaveChat() {
    cancelResponse();
    if (voiceMode) exitVoiceMode();
    activeNpcId = null;
    saveState();
  }
  navToSuspects.addEventListener("click", () => {
    leaveChat();
    showHub();
    // Activate suspects tab
    document.querySelectorAll(".manila-tab[data-hub-tab]").forEach(t => t.classList.remove("active"));
    document.querySelectorAll(".hub-panel").forEach(p => p.classList.remove("active"));
    document.querySelector('.manila-tab[data-hub-tab="suspects"]').classList.add("active");
    document.getElementById("hub-suspects").classList.add("active");
  });
  navToCaseboard.addEventListener("click", () => {
    leaveChat();
    showHub();
    // Activate caseboard tab
    document.querySelectorAll(".manila-tab[data-hub-tab]").forEach(t => t.classList.remove("active"));
    document.querySelectorAll(".hub-panel").forEach(p => p.classList.remove("active"));
    document.querySelector('.manila-tab[data-hub-tab="caseboard"]').classList.add("active");
    document.getElementById("hub-caseboard").classList.add("active");
    clearCaseBoardBadges();
  });

  // Hub manila folder tabs (only tabs with data-hub-tab attribute)
  document.querySelectorAll(".manila-tab[data-hub-tab]").forEach(tab => {
    tab.addEventListener("click", () => {
      document.querySelectorAll(".manila-tab[data-hub-tab]").forEach(t => t.classList.remove("active"));
      document.querySelectorAll(".hub-panel").forEach(p => p.classList.remove("active"));
      tab.classList.add("active");
      const panelId = `hub-${tab.dataset.hubTab}`;
      document.getElementById(panelId).classList.add("active");
      if (tab.dataset.hubTab === "caseboard") clearCaseBoardBadges();
    });
  });

  // Chat settings tab
  $("#chat-settings-tab").addEventListener("click", openSettings);

  /* ── Portrait Info Button (bio tooltip) ──────────────── */
  const portraitInfoBtn = $("#portrait-info-btn");
  const bioTooltipEl = $("#portrait-bio-tooltip");
  const portraitFrameEl = document.querySelector(".portrait-frame");

  function showBioTooltip() {
    if (!activeNpcId) return;
    const bioKey = `dossier.${activeNpcId}.bio`;
    const bioText = t(bioKey);
    bioTooltipEl.textContent = bioText !== bioKey ? bioText : "";
    bioTooltipEl.classList.add("visible");
  }
  function hideBioTooltip() {
    bioTooltipEl.classList.remove("visible");
  }

  // Desktop: hover to show
  portraitInfoBtn.addEventListener("mouseenter", showBioTooltip);
  portraitFrameEl.addEventListener("mouseleave", hideBioTooltip);
  // Mobile: tap to toggle
  portraitInfoBtn.addEventListener("click", (e) => {
    e.stopPropagation();
    if (bioTooltipEl.classList.contains("visible")) {
      hideBioTooltip();
    } else {
      showBioTooltip();
    }
  });
  // Tap tooltip to dismiss
  bioTooltipEl.addEventListener("click", hideBioTooltip);

  chatInput.addEventListener("input", () => {
    autoResize();
    sendBtn.disabled = !chatInput.value.trim() || sending;
  });

  chatInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  sendBtn.addEventListener("click", () => sendMessage());

  // Lila hint button — sends detailed prompt but shows a casual message in chat
  const HINT_DISPLAY_KEYS = [
    "chat.hint_display.0", "chat.hint_display.1", "chat.hint_display.2",
    "chat.hint_display.3", "chat.hint_display.4", "chat.hint_display.5",
    "chat.hint_display.6", "chat.hint_display.7", "chat.hint_display.8",
    "chat.hint_display.9",
  ];
  document.getElementById("lila-hint-btn").addEventListener("click", () => {
    if (sending || activeNpcId !== "lila-chen") return;
    const displayKey = HINT_DISPLAY_KEYS[Math.floor(Math.random() * HINT_DISPLAY_KEYS.length)];
    sendMessage(t("chat.hint_prompt"), t(displayKey));
  });

  cancelAccuse.addEventListener("click", closeAccusationModal);
  confirmAccuse.addEventListener("click", resolveAccusation);

  restartBtn.addEventListener("click", async () => {
    restartBtn.disabled = true;
    await clearState();
    briefingOpen = true;
    outcomeScreen.classList.remove("visible");
    chatScreen.classList.remove("active");
    hubScreen.classList.remove("active");
    chatMessages.innerHTML = "";
    await init();
    restartBtn.disabled = false;
  });

  // Close modal on backdrop click
  accusationModal.addEventListener("click", (e) => {
    if (e.target === accusationModal) closeAccusationModal();
  });

  /* ── Case-Ready Modal (endgame trigger) ──────────────────── */
  const caseReadyModal = $("#case-ready-modal");
  $("#case-ready-review").addEventListener("click", () => {
    caseReadyModal.classList.remove("visible");
    showHub();
    // Switch to caseboard tab
    document.querySelectorAll(".manila-tab[data-hub-tab]").forEach(t => t.classList.remove("active"));
    document.querySelectorAll(".hub-panel").forEach(p => p.classList.remove("active"));
    const cbTab = document.querySelector('.manila-tab[data-hub-tab="caseboard"]');
    if (cbTab) cbTab.classList.add("active");
    const cbPanel = document.getElementById("hub-caseboard");
    if (cbPanel) cbPanel.classList.add("active");
  });
  $("#case-ready-accuse").addEventListener("click", () => {
    caseReadyModal.classList.remove("visible");
    openAccusationModal();
  });
  $("#case-ready-continue").addEventListener("click", () => {
    caseReadyModal.classList.remove("visible");
  });
  caseReadyModal.addEventListener("click", (e) => {
    if (e.target === caseReadyModal) caseReadyModal.classList.remove("visible");
  });

  /* ── Keycard Logs Terminal Modal ────────────────────────── */
  let keycardLogsCache = null;
  const keycardModal = document.getElementById("keycard-modal");
  const keycardBody  = document.getElementById("keycard-terminal-body");

  function fmtTime(ts) {
    return ts.substring(11, 19);
  }

  function padEnd(s, len) {
    return s.length >= len ? s : s + " ".repeat(len - s.length);
  }

  function renderKeycardLogs(logs) {
    let html = `<div class="kc-header">
      <span>${t("keycard.col_time")}</span><span>${t("keycard.col_zone")}</span><span>${t("keycard.col_card")}</span><span>${t("keycard.col_holder")}</span><span>${t("keycard.col_dir")}</span><span>${t("keycard.col_status")}</span>
    </div>`;
    for (const l of logs) {
      if (l.card_id === "SYSTEM") {
        const isOff = l.access === "system_offline";
        const icon = isOff ? "⚠" : "✓";
        const cls = isOff ? "offline" : "restored";
        const sysText = isOff ? t("keycard.system_offline") : t("keycard.system_restored");
        html += `<div class="kc-system ${cls}">
          <span class="kc-system-icon">${icon}</span>
          <span class="kc-system-time">${fmtTime(l.timestamp)}</span>  ${sysText}
        </div>`;
      } else {
        const dirCls = l.direction === "entry" ? "entry" : "exit";
        const dirLabel = l.direction === "entry" ? t("keycard.entry") : t("keycard.exit");
        const statusLabel = t("keycard.granted");
        const zoneLabel = t("keycard.zone." + l.zone) || l.zone;
        html += `<div class="kc-row">
          <span class="kc-time">${fmtTime(l.timestamp)}</span>
          <span class="kc-zone">${zoneLabel}</span>
          <span class="kc-card">${l.card_id}</span>
          <span class="kc-holder">${l.card_holder}</span>
          <span class="kc-dir ${dirCls}">${dirLabel}</span>
          <span class="kc-access">${statusLabel}</span>
        </div>`;
      }
    }
    keycardBody.innerHTML = html;
  }

  window.__openKeycardModal = async function() {
    keycardModal.classList.add("visible");
    // Re-translate terminal header for current language
    document.querySelector(".keycard-terminal-title").textContent = t("keycard.title");
    document.querySelector(".keycard-terminal-info").textContent = t("keycard.subtitle");
    if (keycardLogsCache) {
      renderKeycardLogs(keycardLogsCache);
      return;
    }
    keycardBody.innerHTML = '<div style="padding:2rem;text-align:center;color:rgba(120,220,100,0.4);font-family:var(--font-mono);font-size:0.75rem;">' + t("keycard.loading") + '</div>';
    try {
      const resp = await fetch("data/keycard_logs.json");
      keycardLogsCache = await resp.json();
      renderKeycardLogs(keycardLogsCache);
    } catch (err) {
      keycardBody.innerHTML = '<div style="padding:2rem;text-align:center;color:rgba(220,60,40,0.8);font-family:var(--font-mono);font-size:0.75rem;">' + t("keycard.error") + '</div>';
    }
  };

  function closeKeycardModal() {
    keycardModal.classList.remove("visible");
  }

  document.getElementById("keycard-modal-close").addEventListener("click", closeKeycardModal);
  keycardModal.addEventListener("click", (e) => {
    if (e.target === keycardModal) closeKeycardModal();
  });

  /* ── Voice: Audio Toggle ────────────────────────────────── */
  function updateAudioToggle() {
    audioToggle.classList.toggle("active", audioEnabled);
    audioToggle.title = audioEnabled ? t("voice.audio_on") : t("voice.audio_off");
  }

  audioToggle.addEventListener("click", () => {
    audioEnabled = !audioEnabled;
    localStorage.setItem("echoes_audio", audioEnabled);
    updateAudioToggle();
    if (!audioEnabled && currentAudio) {
      currentAudio.pause();
      currentAudio = null;
    }
  });

  /* ── Voice: TTS Playback ───────────────────────────────── */
  async function speakText(text, npcId, cacheKey) {
    /* Stop any in-flight TTS fetch or playing audio first */
    if (ttsAbortController) { ttsAbortController.abort(); ttsAbortController = null; }
    if (currentAudio) { currentAudio.pause(); currentAudio.currentTime = 0; currentAudio = null; }

    if (audioCache.has(cacheKey)) {
      playAudioBlob(audioCache.get(cacheKey), cacheKey);
      return;
    }

    const voice = npcVoices[npcId] || "alloy";
    ttsAbortController = new AbortController();
    showCancelBtn();
    try {
      const res = await fetch(`${API_BASE}/api/speak`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text, voice }),
        signal: ttsAbortController.signal,
      });
      if (!res.ok) throw new Error(`TTS failed: HTTP ${res.status}`);
      const blob = await res.blob();
      const blobUrl = URL.createObjectURL(blob);
      audioCache.set(cacheKey, blobUrl);
      ttsAbortController = null;
      playAudioBlob(blobUrl, cacheKey);
    } catch (err) {
      ttsAbortController = null;
      if (err.name !== "AbortError") console.error("TTS error:", err);
      if (!sending && !currentAudio) hideCancelBtn();
    }
  }

  function playAudioBlob(blobUrl, cacheKey) {
    if (currentAudio) { currentAudio.pause(); currentAudio.currentTime = 0; }

    const audio = new Audio(blobUrl);
    currentAudio = audio;
    showCancelBtn();

    const replayBtn = document.querySelector(`.msg-audio-btn[data-cache-key="${cacheKey}"]`);
    if (replayBtn) replayBtn.classList.add("playing");
    if (activeNpcId) portraitStatus.textContent = t("voice.status_speaking");

    audio.onended = () => {
      currentAudio = null;
      if (replayBtn) replayBtn.classList.remove("playing");
      if (activeNpcId) portraitStatus.textContent = "";
      if (!sending) hideCancelBtn();
      if (voiceMode && !sending) {
        setTimeout(() => { if (voiceMode) startRecording(); }, 400);
      }
    };
    audio.onerror = () => {
      currentAudio = null;
      if (replayBtn) replayBtn.classList.remove("playing");
      if (activeNpcId) portraitStatus.textContent = "";
      if (!sending) hideCancelBtn();
      if (voiceMode && !sending) {
        setTimeout(() => { if (voiceMode) startRecording(); }, 400);
      }
    };
    audio.play().catch(console.error);
  }

  /* ── Voice: Microphone Recording with Silence Detection ── */
  const SILENCE_THRESHOLD = 0.01;
  const SILENCE_DURATION  = 1500;

  async function startRecording() {
    if (isRecording || isTranscribing || sending) return;
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      audioChunks = [];
      mediaRecorder = new MediaRecorder(stream, {
        mimeType: MediaRecorder.isTypeSupported("audio/webm;codecs=opus")
          ? "audio/webm;codecs=opus" : "audio/webm",
      });

      mediaRecorder.ondataavailable = (e) => {
        if (e.data.size > 0) audioChunks.push(e.data);
      };

      mediaRecorder.onstop = async () => {
        stopSilenceDetection();
        stream.getTracks().forEach(track => track.stop());
        const blob = new Blob(audioChunks, { type: "audio/webm" });
        if (blob.size < 100) {
          if (voiceMode) setTimeout(() => { if (voiceMode) startRecording(); }, 300);
          return;
        }
        await transcribeAudio(blob);
      };

      audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const source = audioContext.createMediaStreamSource(stream);
      analyserNode = audioContext.createAnalyser();
      analyserNode.fftSize = 2048;
      source.connect(analyserNode);

      let silentSince = null;
      let hasSpoken = false;
      const dataArray = new Float32Array(analyserNode.fftSize);

      function checkSilence() {
        if (!isRecording) return;
        analyserNode.getFloatTimeDomainData(dataArray);
        let sum = 0;
        for (let i = 0; i < dataArray.length; i++) sum += dataArray[i] * dataArray[i];
        const rms = Math.sqrt(sum / dataArray.length);

        if (rms > SILENCE_THRESHOLD) {
          hasSpoken = true;
          silentSince = null;
        } else if (hasSpoken) {
          if (!silentSince) silentSince = Date.now();
          else if (Date.now() - silentSince > SILENCE_DURATION) {
            stopRecording();
            return;
          }
        }
        silenceCheckRAF = requestAnimationFrame(checkSilence);
      }

      mediaRecorder.start();
      isRecording = true;
      micBtn.classList.remove("processing", "waiting");
      micBtn.classList.add("recording");
      micBtn.title = t("voice.mic_recording");
      if (voiceMode) portraitStatus.textContent = t("voice.listening");

      silenceCheckRAF = requestAnimationFrame(checkSilence);
    } catch (err) {
      if (err.name === "NotAllowedError") {
        alert(t("voice.mic_denied"));
        exitVoiceMode();
      } else {
        alert(t("voice.mic_error", { message: err.message }));
        exitVoiceMode();
      }
    }
  }

  function stopSilenceDetection() {
    if (silenceCheckRAF) { cancelAnimationFrame(silenceCheckRAF); silenceCheckRAF = null; }
    if (audioContext) { audioContext.close().catch(() => {}); audioContext = null; }
    analyserNode = null;
  }

  function stopRecording() {
    stopSilenceDetection();
    if (mediaRecorder && mediaRecorder.state !== "inactive") {
      mediaRecorder.stop();
    }
    isRecording = false;
    micBtn.classList.remove("recording");
    if (!voiceMode) micBtn.title = t("voice.mic_title");
  }

  /* ── Voice Mode Toggle ─────────────────────────────────── */
  function enterVoiceMode() {
    voiceMode = true;
    audioEnabled = true;
    localStorage.setItem("echoes_audio", "true");
    updateAudioToggle();
    micBtn.classList.add("voice-mode");
    micBtn.title = t("voice.mode_active");
    startRecording();
  }

  function exitVoiceMode() {
    voiceMode = false;
    if (isRecording) stopRecording();
    micBtn.classList.remove("voice-mode", "recording", "processing", "waiting");
    micBtn.title = t("voice.mic_title");
    if (activeNpcId && !sending) portraitStatus.textContent = "";
  }

  micBtn.addEventListener("click", () => {
    if (isTranscribing || sending) return;
    if (voiceMode) {
      exitVoiceMode();
    } else if (isRecording) {
      stopRecording();
    } else {
      enterVoiceMode();
    }
  });

  /* ── Voice: Transcription ──────────────────────────────── */
  async function transcribeAudio(blob) {
    isTranscribing = true;
    micBtn.classList.remove("recording");
    micBtn.classList.add("processing");
    micBtn.title = t("voice.mic_processing");
    if (voiceMode) portraitStatus.textContent = t("voice.mic_processing");

    try {
      const formData = new FormData();
      formData.append("file", blob, "recording.webm");
      formData.append("language", window.currentLang || "en");

      const res = await fetch(`${API_BASE}/api/transcribe`, {
        method: "POST",
        body: formData,
      });

      if (!res.ok) {
        const err = await res.json().catch(() => ({ detail: "Transcription error" }));
        throw new Error(err.detail || `HTTP ${res.status}`);
      }

      const data = await res.json();
      if (data.text && data.text.trim()) {
        if (voiceMode) {
          micBtn.classList.remove("processing");
          micBtn.classList.add("waiting");
          await sendMessage(data.text.trim());
        } else {
          chatInput.value = data.text.trim();
          autoResize();
          sendBtn.disabled = false;
          chatInput.focus();
        }
      } else if (voiceMode) {
        setTimeout(() => { if (voiceMode) startRecording(); }, 300);
      }
    } catch (err) {
      const errDiv = document.createElement("div");
      errDiv.style.cssText = "text-align:center; color:var(--danger); font-size:0.82rem; padding:0.5rem;";
      errDiv.textContent = t("voice.mic_error", { message: err.message });
      chatMessages.appendChild(errDiv);
      scrollToBottom();
      if (voiceMode) setTimeout(() => { if (voiceMode) startRecording(); }, 1000);
    } finally {
      isTranscribing = false;
      micBtn.classList.remove("processing");
      if (!voiceMode) micBtn.title = t("voice.mic_title");
    }
  }

  // Hide mic if browser doesn't support it
  if (!navigator.mediaDevices || !window.MediaRecorder) {
    micBtn.style.display = "none";
  }

  /* ── Language Toggle ────────────────────────────────────── */
  function initLanguage() {
    const saved = localStorage.getItem("echoes_lang") || "en";
    window.currentLang = saved;
    applyLanguage(saved);
  }

  function switchLanguage(lang) {
    applyLanguage(lang);
    renderNpcGrid();
    renderEvidence();
    if (activeNpcId) {
      renderMessages();
      // Update programmatically-set NPC role text in chat screen
      portraitRole.textContent = npcRole(activeNpcId);
      // topbar has nav buttons now, no role text to update
      portraitStatus.textContent = sending ? t("chat.status_responding") : "";
    }
  }

  document.querySelectorAll(".lang-btn").forEach(btn => {
    btn.addEventListener("click", () => switchLanguage(btn.dataset.lang));
  });

  /* ── Tutorial Coach Marks System ─────────────────────────── */
  const TUTORIAL_STORAGE_KEY = "echoes_tutorial_done";
  const tutorialOverlay  = $("#tutorial-overlay");
  const tutorialBackdrop = $("#tutorial-backdrop");
  const tutorialTooltip  = $("#tutorial-tooltip");
  const tutorialText     = $("#tutorial-text");
  const tutorialStepInd  = $("#tutorial-step-indicator");
  const tutorialSkipBtn  = $("#tutorial-skip");
  const tutorialNextBtn  = $("#tutorial-next");

  // Hub-phase steps (shown on first load)
  const HUB_STEPS = [
    { selector: '.manila-tab[data-hub-tab="caseboard"]', text: "tutorial.step_caseboard", arrow: "top" },
    { selector: '#cb-briefing-toggle', text: "tutorial.step_briefing", arrow: "top" },
    { selector: '.manila-tab[data-hub-tab="suspects"]', text: "tutorial.step_suspects", arrow: "top", clickToAdvance: true },
    { selector: '.npc-card[data-npc-id="lila-chen"]', text: "tutorial.step_partner", arrow: "top", beforeShow() {
      // Ensure suspects tab is active (user just clicked it in the previous step)
      document.querySelectorAll(".manila-tab[data-hub-tab]").forEach(t => t.classList.remove("active"));
      document.querySelectorAll(".hub-panel").forEach(p => p.classList.remove("active"));
      document.querySelector('.manila-tab[data-hub-tab="suspects"]').classList.add("active");
      document.getElementById("hub-suspects").classList.add("active");
    }},
    { selector: '.npc-card:not([data-npc-id="lila-chen"])', text: "tutorial.step_npc_card", arrow: "top" },
  ];

  // Chat-phase steps (shown after entering chat for the first time)
  const isTouchDevice = "ontouchstart" in window || navigator.maxTouchPoints > 0;
  const CHAT_STEPS = [
    { selector: '#gauge-pressure', text: "tutorial.step_gauges", arrow: "bottom", selectorAlt: '#gauge-rapport' },
    { selector: '#portrait-info-btn', text: isTouchDevice ? "tutorial.step_info_mobile" : "tutorial.step_info_desktop", arrow: "left" },
    { selector: '#chat-input-bar', text: "tutorial.step_input", arrow: "bottom" },
  ];
  // Suspect chat steps without input bar (used when Lila chat already covered it)
  const CHAT_STEPS_SHORT = [
    { selector: '#gauge-pressure', text: "tutorial.step_gauges", arrow: "bottom", selectorAlt: '#gauge-rapport' },
    { selector: '#portrait-info-btn', text: isTouchDevice ? "tutorial.step_info_mobile" : "tutorial.step_info_desktop", arrow: "left" },
  ];

  // Lila-specific tutorial (shown the first time Lila's chat is opened)
  const LILA_HINT_STORAGE_KEY = "echoes_lila_hint_seen";
  const LILA_STEPS = [
    { selector: '#lila-hint-btn', text: "tutorial.step_hint_btn", arrow: "bottom" },
  ];
  // Combined Lila tutorial for when Lila is opened first (hint btn + input bar)
  const LILA_CHAT_STEPS = [
    { selector: '#lila-hint-btn', text: "tutorial.step_hint_btn", arrow: "bottom" },
    { selector: '#chat-input-bar', text: "tutorial.step_input", arrow: "bottom" },
  ];

  let tutorialSteps = [];
  let tutorialCurrentStep = 0;
  let tutorialPhase = null; // "hub" or "chat"
  let tutorialResizeRAF = null;
  let tutorialClickTarget = null;   // element we're listening on for clickToAdvance
  let tutorialClickHandler = null;  // handler to remove later
  let tutorialPulseRing = null;     // pulsing ring element

  function isTutorialDone() {
    return localStorage.getItem(TUTORIAL_STORAGE_KEY) === "true";
  }
  function markTutorialDone() {
    localStorage.setItem(TUTORIAL_STORAGE_KEY, "true");
  }

  function startTutorial(phase) {
    tutorialPhase = phase;
    tutorialSteps = phase === "hub" ? HUB_STEPS
                  : phase === "lila" ? LILA_STEPS
                  : phase === "lila_chat" ? LILA_CHAT_STEPS
                  : phase === "chat_short" ? CHAT_STEPS_SHORT
                  : CHAT_STEPS;
    tutorialCurrentStep = 0;
    showTutorialStep(0);
  }

  function cleanupClickToAdvance() {
    if (tutorialClickTarget && tutorialClickHandler) {
      tutorialClickTarget.removeEventListener("click", tutorialClickHandler);
      tutorialClickTarget.style.zIndex = "";
      tutorialClickTarget = null;
      tutorialClickHandler = null;
    }
    if (tutorialPulseRing) {
      tutorialPulseRing.remove();
      tutorialPulseRing = null;
    }
  }

  function showTutorialStep(idx) {
    if (idx < 0 || idx >= tutorialSteps.length) { endTutorial(); return; }
    cleanupClickToAdvance();
    tutorialCurrentStep = idx;
    const step = tutorialSteps[idx];

    // Run pre-show action (e.g. switch tabs) before looking for the target
    if (step.beforeShow) step.beforeShow();

    const target = document.querySelector(step.selector);
    if (!target) { showTutorialStep(idx + 1); return; }

    // Ensure target is visible (scroll into view)
    target.scrollIntoView({ behavior: "smooth", block: "nearest" });

    requestAnimationFrame(() => {
      const rect = target.getBoundingClientRect();
      // If we have an alt selector (for grouping gauges), expand the rect
      let spotRect = { top: rect.top, left: rect.left, right: rect.right, bottom: rect.bottom };
      if (step.selectorAlt) {
        const alt = document.querySelector(step.selectorAlt);
        if (alt) {
          const altRect = alt.getBoundingClientRect();
          spotRect.top = Math.min(spotRect.top, altRect.top);
          spotRect.left = Math.min(spotRect.left, altRect.left);
          spotRect.right = Math.max(spotRect.right, altRect.right);
          spotRect.bottom = Math.max(spotRect.bottom, altRect.bottom);
        }
      }

      const pad = 8;
      const sx = spotRect.left - pad;
      const sy = spotRect.top - pad;
      const sw = (spotRect.right - spotRect.left) + pad * 2;
      const sh = (spotRect.bottom - spotRect.top) + pad * 2;

      // Create a clip-path that cuts out the spotlight area (inverted rect)
      tutorialBackdrop.style.clipPath =
        `polygon(0% 0%, 0% 100%, ${sx}px 100%, ${sx}px ${sy}px, ${sx + sw}px ${sy}px, ${sx + sw}px ${sy + sh}px, ${sx}px ${sy + sh}px, ${sx}px 100%, 100% 100%, 100% 0%)`;

      // Position tooltip
      const isLila = tutorialPhase === "lila";
      const isLilaChat = tutorialPhase === "lila_chat";
      const isChatShort = tutorialPhase === "chat_short";
      const isChatLike = tutorialPhase === "chat" || isChatShort;
      const globalIdx = (isLila || isLilaChat) ? idx : isChatLike ? HUB_STEPS.length + idx : idx;
      const globalTotal = (isLila || isLilaChat) ? tutorialSteps.length : HUB_STEPS.length + tutorialSteps.length;
      tutorialStepInd.textContent = `${globalIdx + 1} / ${globalTotal}`;
      tutorialText.textContent = t(step.text);

      const isLast = isLila || (isLilaChat && idx === LILA_CHAT_STEPS.length - 1) || (isChatLike && idx === tutorialSteps.length - 1);
      tutorialSkipBtn.textContent = t("tutorial.skip");

      // clickToAdvance: hide Next button, show pulsing ring, advance on target click
      if (step.clickToAdvance) {
        tutorialNextBtn.style.display = "none";
        // Create pulsing ring over the target
        tutorialPulseRing = document.createElement("div");
        tutorialPulseRing.className = "tutorial-pulse-ring";
        tutorialPulseRing.style.left = sx + "px";
        tutorialPulseRing.style.top = sy + "px";
        tutorialPulseRing.style.width = sw + "px";
        tutorialPulseRing.style.height = sh + "px";
        document.body.appendChild(tutorialPulseRing);
        // Let clicks pass through to the target in the spotlight area
        tutorialClickTarget = target;
        tutorialClickHandler = () => {
          cleanupClickToAdvance();
          nextTutorialStep();
        };
        target.addEventListener("click", tutorialClickHandler, { once: true });
        // Allow clicking the spotlighted target through the overlay
        target.style.position = target.style.position || "relative";
        target.style.zIndex = "10002";
      } else {
        tutorialNextBtn.style.display = "";
        tutorialNextBtn.textContent = isLast ? t("tutorial.got_it") : t("tutorial.next");
      }
      tutorialSkipBtn.style.display = isLast ? "none" : "";

      // Arrow direction + tooltip position
      tutorialTooltip.className = "tutorial-tooltip arrow-" + step.arrow;
      const ttW = 340;
      let ttLeft, ttTop;

      if (step.arrow === "top") {
        // Tooltip below target
        ttLeft = Math.max(12, Math.min(sx, window.innerWidth - ttW - 12));
        ttTop = sy + sh + 16;
      } else if (step.arrow === "bottom") {
        // Tooltip above target
        ttLeft = Math.max(12, Math.min(sx, window.innerWidth - ttW - 12));
        ttTop = sy - 160;
        if (ttTop < 12) ttTop = sy + sh + 16; // flip if no room above
      } else if (step.arrow === "left") {
        // Tooltip to the right of target
        ttLeft = sx + sw + 16;
        ttTop = sy;
        if (ttLeft + ttW > window.innerWidth - 12) {
          ttLeft = sx - ttW - 16;
          tutorialTooltip.className = "tutorial-tooltip arrow-right";
        }
      } else {
        // arrow-right: tooltip to the left of target
        ttLeft = sx - ttW - 16;
        ttTop = sy;
      }

      tutorialTooltip.style.left = ttLeft + "px";
      tutorialTooltip.style.top = Math.max(12, ttTop) + "px";

      tutorialOverlay.classList.add("active");
    });
  }

  function nextTutorialStep() {
    if (tutorialCurrentStep + 1 < tutorialSteps.length) {
      showTutorialStep(tutorialCurrentStep + 1);
    } else {
      endTutorial();
    }
  }

  function endTutorial() {
    cleanupClickToAdvance();
    tutorialOverlay.classList.remove("active");
    if (tutorialPhase === "hub") {
      // Don't mark as done yet — chat steps remain
    } else if (tutorialPhase === "lila" || tutorialPhase === "lila_chat") {
      localStorage.setItem(LILA_HINT_STORAGE_KEY, "1");
      // Don't markTutorialDone — chat steps for suspects still pending
    } else {
      markTutorialDone();
    }
    tutorialPhase = null;
  }

  function skipTutorial() {
    cleanupClickToAdvance();
    tutorialOverlay.classList.remove("active");

    if (tutorialPhase === "lila" || tutorialPhase === "lila_chat") {
      localStorage.setItem(LILA_HINT_STORAGE_KEY, "1");
      // Don't markTutorialDone — chat steps for suspects still pending
    } else if (tutorialPhase === "hub") {
      // Don't mark tutorial as fully done — chat steps should still fire.
      // If user skipped before reaching the suspects tab, set up a one-time
      // listener so the remaining hub steps (Lila + suspects) appear when
      // they eventually click the tab.
      const suspectsTab = document.querySelector('.manila-tab[data-hub-tab="suspects"]');
      const suspPanel   = document.getElementById("hub-suspects");
      const alreadyOnSuspects = suspPanel && suspPanel.classList.contains("active");

      if (!alreadyOnSuspects && suspectsTab) {
        // Resume from the Lila step (index 3) when user clicks suspects tab
        const resumeFromLila = () => {
          tutorialPhase = "hub";
          tutorialSteps = HUB_STEPS;
          tutorialCurrentStep = 3; // Lila partner step
          showTutorialStep(3);
        };
        suspectsTab.addEventListener("click", () => {
          setTimeout(resumeFromLila, 350);
        }, { once: true });
      }
      // Keep chatTutorialPending alive so chat tutorial still fires
    } else {
      markTutorialDone();
    }
    tutorialPhase = null;
  }

  // Reposition on resize
  window.addEventListener("resize", () => {
    if (!tutorialOverlay.classList.contains("active")) return;
    if (tutorialResizeRAF) cancelAnimationFrame(tutorialResizeRAF);
    tutorialResizeRAF = requestAnimationFrame(() => showTutorialStep(tutorialCurrentStep));
  });

  tutorialNextBtn.addEventListener("click", nextTutorialStep);
  tutorialSkipBtn.addEventListener("click", skipTutorial);

  // Settings replay button
  document.getElementById("settings-tutorial-btn").addEventListener("click", () => {
    closeSettings();
    localStorage.removeItem(TUTORIAL_STORAGE_KEY);
    localStorage.removeItem(LILA_HINT_STORAGE_KEY);
    chatTutorialPending = true; // ensure chat-phase tutorial fires after hub replay
    // Navigate to hub/caseboard first
    if (chatScreen.classList.contains("active")) {
      leaveChat();
      showHub();
    }
    document.querySelectorAll(".manila-tab[data-hub-tab]").forEach(t => t.classList.remove("active"));
    document.querySelectorAll(".hub-panel").forEach(p => p.classList.remove("active"));
    document.querySelector('.manila-tab[data-hub-tab="caseboard"]').classList.add("active");
    document.getElementById("hub-caseboard").classList.add("active");
    setTimeout(() => startTutorial("hub"), 400);
  });

  // Flag for chat-phase tutorial (set during boot, consumed in selectNpc)
  let chatTutorialPending = false;

  /* ── Boot ───────────────────────────────────────────────── */
  initLanguage();
  updateAudioToggle();
  initAuthUI();

  // Check Supabase availability and restore auth session
  // Store promise so init() can await it before first render
  _cloudMergePromise = checkSupabaseStatus().then(async configured => {
    if (!configured) {
      const accountRow = document.getElementById("settings-account-row");
      if (accountRow) accountRow.style.display = "none";
      return;
    }
    const restored = await restoreAuthSession();
    if (restored) {
      console.log("[auth] Session restored for", authUser.email);
      await mergeCloudState();
    }
  });

  // Flush cloud save when tab becomes hidden — use keepalive fetch for reliability
  document.addEventListener("visibilitychange", () => {
    if (document.visibilityState === "hidden" && authUser?.access_token && cloudSavePending) {
      try {
        const stateObj = buildStateObject();
        fetch(`${API_BASE}/api/state/save`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${authUser.access_token}`,
          },
          body: JSON.stringify({ state: stateObj }),
          keepalive: true, // survives page hide
        }).then(() => { cloudSavePending = false; }).catch(() => {});
      } catch {}
    }
  });
  // beforeunload: use sendBeacon as last resort (guaranteed to be queued)
  window.addEventListener("beforeunload", () => {
    if (authUser && cloudSavePending) {
      cloudSaveBeacon();
    }
  });

  // Shared: enter the game (dismiss title card or auth prompt, show hub)
  function enterGame() {
    titleCard.classList.add("dismissed");
    localStorage.setItem(TITLE_STORAGE_KEY, "1");
    document.getElementById("auth-prompt").classList.add("hidden");
    setTimeout(() => {
      titleCard.classList.add("hidden");
      showHubOnCaseboard();
      if (!isTutorialDone()) {
        chatTutorialPending = true;
        setTimeout(() => startTutorial("hub"), 500);
      }
    }, 500);
  }

  // Title card "Open Case File" button
  titleCardBtn.addEventListener("click", () => {
    // If Supabase configured and user not logged in, show auth prompt
    if (supabaseConfigured && !authUser) {
      titleCard.classList.add("dismissed");
      localStorage.setItem(TITLE_STORAGE_KEY, "1");
      setTimeout(() => {
        titleCard.classList.add("hidden");
        document.getElementById("auth-prompt").classList.remove("hidden");
      }, 500);
      return;
    }
    // Already logged in or no Supabase — go straight to game
    enterGame();
  });

  // Auth prompt buttons
  document.getElementById("auth-prompt-skip").addEventListener("click", () => {
    document.getElementById("auth-prompt").classList.add("hidden");
    showHubOnCaseboard();
    if (!isTutorialDone()) {
      chatTutorialPending = true;
      setTimeout(() => startTutorial("hub"), 500);
    }
  });

  function authPromptFlow(tab) {
    const tabBtns = document.querySelectorAll("[data-auth-tab]");
    tabBtns.forEach(b => b.classList.toggle("active", b.dataset.authTab === tab));
    const submitBtn = document.getElementById("auth-submit");
    if (submitBtn) submitBtn.textContent = tab === "signup" ? "Create Account" : "Sign In";
    window.__authFromTitleCard = true;
    openAuthModal();
  }
  document.getElementById("auth-prompt-signin").addEventListener("click", () => authPromptFlow("login"));
  document.getElementById("auth-prompt-signup").addEventListener("click", () => authPromptFlow("signup"));

  init().then(() => {
    // Start tutorial on first visit (no existing conversations = new player)
    // Only if title card was already seen (returning player who hasn't done tutorial)
    const hasConversations = Object.keys(conversations).length > 0;
    const titleSeen = localStorage.getItem(TITLE_STORAGE_KEY);
    if (titleSeen && !isTutorialDone() && !hasConversations) {
      chatTutorialPending = true; // will fire when NPC selected
      setTimeout(() => startTutorial("hub"), 600);
    }
  });
})();
</script>
</body>
</html>
